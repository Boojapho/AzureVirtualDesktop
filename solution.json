{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.18.4.5664",
      "templateHash": "4973819778895092843"
    }
  },
  "parameters": {
    "_artifactsLocation": {
      "type": "string",
      "defaultValue": "https://raw.githubusercontent.com/jamasten/AzureVirtualDesktop/main/artifacts/",
      "metadata": {
        "description": "The URL prefix for linked resources."
      }
    },
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "The SAS Token for the scripts if they are stored on an Azure Storage Account."
      }
    },
    "ActiveDirectorySolution": {
      "type": "string",
      "metadata": {
        "description": "The service providing domain services for Azure Virtual Desktop.  This is needed to properly configure the session hosts and if applicable, the Azure Storage Account."
      },
      "allowedValues": [
        "ActiveDirectoryDomainServices",
        "AzureActiveDirectoryDomainServices",
        "AzureActiveDirectory",
        "AzureActiveDirectoryIntuneEnrollment"
      ]
    },
    "Availability": {
      "type": "string",
      "defaultValue": "AvailabilityZones",
      "metadata": {
        "description": "Set the desired availability / SLA with a pooled host pool.  The best practice is to deploy to Availability Zones for resilency."
      },
      "allowedValues": [
        "AvailabilitySet",
        "AvailabilityZones",
        "None"
      ]
    },
    "AvdObjectId": {
      "type": "string",
      "metadata": {
        "description": "The Object ID for the Windows Virtual Desktop Enterprise Application in Azure AD.  The Object ID can found by selecting Microsoft Applications using the Application type filter in the Enterprise Applications blade of Azure AD."
      }
    },
    "AzureFilesPrivateDnsZoneResourceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "If using private endpoints with Azure Files, input the Resource ID for the Private DNS Zone linked to your hub virtual network."
      }
    },
    "CustomRdpProperty": {
      "type": "string",
      "defaultValue": "audiocapturemode:i:1;camerastoredirect:s:*;use multimon:i:0;drivestoredirect:s:;",
      "metadata": {
        "description": "Input RDP properties to add or remove RDP functionality on the AVD host pool. Settings reference: https://learn.microsoft.com/windows-server/remote/remote-desktop-services/clients/rdp-files"
      }
    },
    "DiskEncryption": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Server-Side Encrytion and Encryption at Host on the AVD session hosts and management VM."
      }
    },
    "DiskSku": {
      "type": "string",
      "defaultValue": "Premium_LRS",
      "metadata": {
        "description": "The storage SKU for the AVD session host disks.  Production deployments should use Premium_LRS."
      },
      "allowedValues": [
        "Standard_LRS",
        "StandardSSD_LRS",
        "Premium_LRS"
      ]
    },
    "DomainJoinPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "The password of the privileged account to domain join the AVD session hosts to your domain"
      }
    },
    "DomainJoinUserPrincipalName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The UPN of the privileged account to domain join the AVD session hosts to your domain. This should be an account the resides within the domain you are joining."
      }
    },
    "DomainName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The name of the domain that provides ADDS to the AVD session hosts and is synchronized with Azure AD"
      }
    },
    "DrainMode": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable drain mode on new sessions hosts to prevent users from accessing them until they are validated."
      }
    },
    "Environment": {
      "type": "string",
      "defaultValue": "d",
      "metadata": {
        "description": "The target environment for the solution."
      },
      "allowedValues": [
        "d",
        "p",
        "s",
        "t"
      ]
    },
    "FslogixShareSizeInGB": {
      "type": "int",
      "defaultValue": 100,
      "metadata": {
        "description": "The file share size(s) in GB for the Fslogix storage solution."
      }
    },
    "FslogixSolution": {
      "type": "string",
      "defaultValue": "ProfileContainer",
      "allowedValues": [
        "CloudCacheProfileContainer",
        "CloudCacheProfileOfficeContainer",
        "ProfileContainer",
        "ProfileOfficeContainer"
      ]
    },
    "FslogixStorage": {
      "type": "string",
      "defaultValue": "AzureStorageAccount Standard PublicEndpoint",
      "metadata": {
        "description": "Enable an Fslogix storage option to manage user profiles for the AVD session hosts. The selected service & SKU should provide sufficient IOPS for all of your users. https://docs.microsoft.com/en-us/azure/architecture/example-scenario/wvd/windows-virtual-desktop-fslogix#performance-requirements"
      },
      "allowedValues": [
        "AzureNetAppFiles Premium",
        "AzureNetAppFiles Standard",
        "AzureNetAppFiles Ultra",
        "AzureStorageAccount Premium PublicEndpoint",
        "AzureStorageAccount Premium PrivateEndpoint",
        "AzureStorageAccount Premium ServiceEndpoint",
        "AzureStorageAccount Standard PublicEndpoint",
        "AzureStorageAccount Standard PrivateEndpoint",
        "AzureStorageAccount Standard ServiceEndpoint",
        "None"
      ]
    },
    "HostPoolType": {
      "type": "string",
      "defaultValue": "Pooled DepthFirst",
      "metadata": {
        "description": "These options specify the host pool type and depending on the type provides the load balancing options and assignment types."
      },
      "allowedValues": [
        "Pooled DepthFirst",
        "Pooled BreadthFirst",
        "Personal Automatic",
        "Personal Direct"
      ]
    },
    "Identifier": {
      "type": "string",
      "defaultValue": "avd",
      "metadata": {
        "description": "The unique identifier between each business unit or project supporting AVD in your tenant. This is the unique naming component between each AVD stamp."
      },
      "maxLength": 3
    },
    "ImageOffer": {
      "type": "string",
      "defaultValue": "office-365",
      "metadata": {
        "description": "Offer for the virtual machine image"
      }
    },
    "ImagePublisher": {
      "type": "string",
      "defaultValue": "MicrosoftWindowsDesktop",
      "metadata": {
        "description": "Publisher for the virtual machine image"
      }
    },
    "ImageSku": {
      "type": "string",
      "defaultValue": "win11-22h2-avd-m365",
      "metadata": {
        "description": "SKU for the virtual machine image"
      }
    },
    "ImageVersion": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "Version for the virtual machine image"
      }
    },
    "KerberosEncryption": {
      "type": "string",
      "defaultValue": "RC4",
      "metadata": {
        "description": "The Active Directory computer object Kerberos encryption type for the Azure Storage Account or Azure NetApp Files Account."
      },
      "allowedValues": [
        "AES256",
        "RC4"
      ]
    },
    "Location": {
      "type": "string",
      "defaultValue": "[deployment().location]"
    },
    "LogAnalyticsWorkspaceRetention": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "The retention for the Log Analytics Workspace to setup the AVD Monitoring solution"
      },
      "minValue": 30,
      "maxValue": 730
    },
    "LogAnalyticsWorkspaceSku": {
      "type": "string",
      "defaultValue": "PerGB2018",
      "metadata": {
        "description": "The SKU for the Log Analytics Workspace to setup the AVD Monitoring solution"
      },
      "allowedValues": [
        "Free",
        "Standard",
        "Premium",
        "PerNode",
        "PerGB2018",
        "Standalone",
        "CapacityReservation"
      ]
    },
    "MaxSessionLimit": {
      "type": "int",
      "metadata": {
        "description": "The maximum number of sessions per AVD session host."
      }
    },
    "Monitoring": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploys the required monitoring resources to enable AVD Insights and monitor features in the automation account."
      }
    },
    "OuPath": {
      "type": "string",
      "metadata": {
        "description": "The distinguished name for the target Organization Unit in Active Directory Domain Services."
      }
    },
    "RecoveryServices": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable backups to an Azure Recovery Services vault.  For a pooled host pool this will enable backups on the Azure file share.  For a personal host pool this will enable backups on the AVD sessions hosts."
      }
    },
    "ScalingBeginPeakTime": {
      "type": "string",
      "defaultValue": "9:00",
      "metadata": {
        "description": "Time when session hosts will scale up and continue to stay on to support peak demand; Format 24 hours e.g. 9:00 for 9am"
      }
    },
    "ScalingEndPeakTime": {
      "type": "string",
      "defaultValue": "17:00",
      "metadata": {
        "description": "Time when session hosts will scale down and stay off to support low demand; Format 24 hours e.g. 17:00 for 5pm"
      }
    },
    "ScalingLimitSecondsToForceLogOffUser": {
      "type": "string",
      "defaultValue": "0",
      "metadata": {
        "description": "The number of seconds to wait before automatically signing out users. If set to 0 any session host that has user sessions will be left untouched"
      }
    },
    "ScalingMinimumNumberOfRdsh": {
      "type": "string",
      "defaultValue": "0",
      "metadata": {
        "description": "The minimum number of session host VMs to keep running during off-peak hours. The scaling tool will not work if all virtual machines are turned off and the Start VM On Connect solution is not enabled."
      }
    },
    "ScalingSessionThresholdPerCPU": {
      "type": "string",
      "defaultValue": "1",
      "metadata": {
        "description": "The maximum number of sessions per CPU that will be used as a threshold to determine when new session host VMs need to be started during peak hours"
      }
    },
    "ScalingTool": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploys the required resources for the Scaling Tool. https://docs.microsoft.com/en-us/azure/virtual-desktop/scaling-automation-logic-apps"
      }
    },
    "ScreenCaptureProtection": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Determines whether the Screen Capture Protection feature is enabled. This feature is only supported on specific clients. https://learn.microsoft.com/azure/virtual-desktop/screen-capture-protection"
      }
    },
    "SecurityPrincipalObjectIds": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "An array of Security Principal object IDs to assign to the AVD Application Group and FSLogix Storage."
      }
    },
    "SecurityPrincipalNames": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "An array of Security Principal names to assign NTFS permissions on the Azure File Share to support Fslogix. This is only required for pooled host pools using FSLogix. The names should align to the object IDs provided in the \"SecurityPrincipalObjectIds\" parameter."
      }
    },
    "SentinelLogAnalyticsWorkspaceName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The name of the log analytics workspace used for Azure Sentinel."
      }
    },
    "SentinelLogAnalyticsWorkspaceResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The name of the resource group containing the log analytics workspace used for Azure Sentinel."
      }
    },
    "SentinelLogAnalyticsWorkspaceSubscriptionId": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "The ID of the subscription containing the log analytics workspace used for Azure Sentinel."
      }
    },
    "SessionHostCount": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "The number of session hosts to deploy in the host pool. Ensure you have the approved quota to deploy the desired count."
      },
      "minValue": 0,
      "maxValue": 5000
    },
    "SessionHostIndex": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "The starting number for the session hosts. This is important when adding virtual machines to ensure an update deployment is not performed on an exiting, active session host."
      },
      "minValue": 0,
      "maxValue": 4999
    },
    "StampIndex": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "The stamp index allows for multiple AVD stamps with the same business unit or project to support different use cases. For example, \"0\" could be used for an office workers host pool and \"1\" could be used for a developers host pool within the \"finance\" business unit."
      },
      "maxValue": 9
    },
    "StorageCount": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "The number of storage accounts to deploy to support the required use case for the AVD stamp. https://docs.microsoft.com/en-us/azure/architecture/patterns/sharding"
      },
      "maxValue": 10
    },
    "StorageIndex": {
      "type": "int",
      "defaultValue": 0,
      "metadata": {
        "description": "The starting number for the storage accounts to support the required use case for the AVD stamp. https://docs.microsoft.com/en-us/azure/architecture/patterns/sharding"
      },
      "maxValue": 9
    },
    "SubnetResourceId": {
      "type": "string",
      "metadata": {
        "description": "The resource ID of the subnet to place the network interfaces for the AVD session hosts."
      }
    },
    "Tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Key / value pairs of metadata for the Azure resources."
      }
    },
    "Timestamp": {
      "type": "string",
      "defaultValue": "[utcNow('yyyyMMddhhmmss')]",
      "metadata": {
        "description": "DO NOT MODIFY THIS VALUE! The timestamp is needed to differentiate deployments for certain Azure resources and must be set using a parameter."
      }
    },
    "ValidationEnvironment": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "The value determines whether the hostpool should receive early AVD updates for testing."
      }
    },
    "VirtualMachinePassword": {
      "type": "securestring",
      "metadata": {
        "description": "Local administrator password for the AVD session hosts"
      }
    },
    "VirtualMachineSize": {
      "type": "string",
      "defaultValue": "Standard_D4ads_v5",
      "metadata": {
        "description": "The VM SKU for the AVD session hosts."
      }
    },
    "VirtualMachineUsername": {
      "type": "string",
      "metadata": {
        "description": "The Local Administrator Username for the Session Hosts"
      }
    }
  },
  "variables": {
    "$fxv#0": {
      "australiacentral": {
        "acronym": "auc",
        "timeDifference": "+10:00",
        "timeZone": "AUS Eastern Standard Time"
      },
      "australiacentral2": {
        "acronym": "auc2",
        "timeDifference": "+10:00",
        "timeZone": "AUS Eastern Standard Time"
      },
      "australiaeast": {
        "acronym": "aue",
        "timeDifference": "+10:00",
        "timeZone": "AUS Eastern Standard Time"
      },
      "australiasoutheast": {
        "acronym": "ause",
        "timeDifference": "+10:00",
        "timeZone": "AUS Eastern Standard Time"
      },
      "brazilsouth": {
        "acronym": "brs",
        "timeDifference": "-3:00",
        "timeZone": "E. South America Standard Time"
      },
      "brazilsoutheast": {
        "acronym": "brse",
        "timeDifference": "-3:00",
        "timeZone": "E. South America Standard Time"
      },
      "canadacentral": {
        "acronym": "cac",
        "timeDifference": "-5:00",
        "timeZone": "Eastern Standard Time"
      },
      "canadaeast": {
        "acronym": "cae",
        "timeDifference": "-5:00",
        "timeZone": "Eastern Standard Time"
      },
      "centralindia": {
        "acronym": "inc",
        "timeDifference": "+5:30",
        "timeZone": "India Standard Time"
      },
      "centralus": {
        "acronym": "usc",
        "timeDifference": "-6:00",
        "timeZone": "Central Standard Time"
      },
      "chinaeast": {
        "acronym": "cne",
        "timeDifference": "+8:00",
        "timeZone": "China Standard Time"
      },
      "chinaeast2": {
        "acronym": "cne2",
        "timeDifference": "+8:00",
        "timeZone": "China Standard Time"
      },
      "chinanorth": {
        "acronym": "cnn",
        "timeDifference": "+8:00",
        "timeZone": "China Standard Time"
      },
      "chinanorth2": {
        "acronym": "cnn2",
        "timeDifference": "+8:00",
        "timeZone": "China Standard Time"
      },
      "eastasia": {
        "acronym": "ase",
        "timeDifference": "+8:00",
        "timeZone": "China Standard Time"
      },
      "eastus": {
        "acronym": "use",
        "timeDifference": "-5:00",
        "timeZone": "Eastern Standard Time"
      },
      "eastus2": {
        "acronym": "use2",
        "timeDifference": "-5:00",
        "timeZone": "Eastern Standard Time"
      },
      "francecentral": {
        "acronym": "frc",
        "timeDifference": "+1:00",
        "timeZone": "Central Europe Standard Time"
      },
      "francesouth": {
        "acronym": "frs",
        "timeDifference": "+1:00",
        "timeZone": "Central Europe Standard Time"
      },
      "germanynorth": {
        "acronym": "den",
        "timeDifference": "+1:00",
        "timeZone": "Central Europe Standard Time"
      },
      "germanywestcentral": {
        "acronym": "dewc",
        "timeDifference": "+1:00",
        "timeZone": "Central Europe Standard Time"
      },
      "japaneast": {
        "acronym": "jpe",
        "timeDifference": "+9:00",
        "timeZone": "Tokyo Standard Time"
      },
      "japanwest": {
        "acronym": "jpw",
        "timeDifference": "+9:00",
        "timeZone": "Tokyo Standard Time"
      },
      "jioindiacentral": {
        "acronym": "injc",
        "timeDifference": "+5:30",
        "timeZone": "India Standard Time"
      },
      "jioindiawest": {
        "acronym": "injw",
        "timeDifference": "+5:30",
        "timeZone": "India Standard Time"
      },
      "koreacentral": {
        "acronym": "krc",
        "timeDifference": "+9:00",
        "timeZone": "Korea Standard Time"
      },
      "koreasouth": {
        "acronym": "krs",
        "timeDifference": "+9:00",
        "timeZone": "Korea Standard Time"
      },
      "northcentralus": {
        "acronym": "usnc",
        "timeDifference": "-6:00",
        "timeZone": "Central Standard Time"
      },
      "northeurope": {
        "acronym": "eun",
        "timeDifference": "0:00",
        "timeZone": "GMT Standard Time"
      },
      "norwayeast": {
        "acronym": "noe",
        "timeDifference": "+1:00",
        "timeZone": "Central Europe Standard Time"
      },
      "norwaywest": {
        "acronym": "now",
        "timeDifference": "+1:00",
        "timeZone": "Central Europe Standard Time"
      },
      "southafricanorth": {
        "acronym": "zan",
        "timeDifference": "+2:00",
        "timeZone": "South Africa Standard Time"
      },
      "southafricawest": {
        "acronym": "zaw",
        "timeDifference": "+2:00",
        "timeZone": "South Africa Standard Time"
      },
      "southcentralus": {
        "acronym": "ussc",
        "timeDifference": "-6:00",
        "timeZone": "Central Standard Time"
      },
      "southeastasia": {
        "acronym": "asse",
        "timeDifference": "+8:00",
        "timeZone": "Singapore Standard Time"
      },
      "southindia": {
        "acronym": "ins",
        "timeDifference": "+5:30",
        "timeZone": "India Standard Time"
      },
      "swedencentral": {
        "acronym": "sec",
        "timeDifference": "+1:00",
        "timeZone": "Central Europe Standard Time"
      },
      "switzerlandnorth": {
        "acronym": "chn",
        "timeDifference": "+1:00",
        "timeZone": "Central Europe Standard Time"
      },
      "switzerlandwest": {
        "acronym": "chw",
        "timeDifference": "+1:00",
        "timeZone": "Central Europe Standard Time"
      },
      "uaecentral": {
        "acronym": "aec",
        "timeDifference": "+3:00",
        "timeZone": "Arabian Standard Time"
      },
      "uaenorth": {
        "acronym": "aen",
        "timeDifference": "+3:00",
        "timeZone": "Arabian Standard Time"
      },
      "uksouth": {
        "acronym": "uks",
        "timeDifference": "0:00",
        "timeZone": "GMT Standard Time"
      },
      "ukwest": {
        "acronym": "ukw",
        "timeDifference": "0:00",
        "timeZone": "GMT Standard Time"
      },
      "usdodcentral": {
        "acronym": "dodc",
        "timeDifference": "-6:00",
        "timeZone": "Central Standard Time"
      },
      "usdodeast": {
        "acronym": "dode",
        "timeDifference": "-5:00",
        "timeZone": "Eastern Standard Time"
      },
      "usgovarizona": {
        "acronym": "az",
        "timeDifference": "-7:00",
        "timeZone": "Mountain Standard Time"
      },
      "usgovtexas": {
        "acronym": "tx",
        "timeDifference": "-6:00",
        "timeZone": "Central Standard Time"
      },
      "usgovvirginia": {
        "acronym": "va",
        "timeDifference": "-5:00",
        "timeZone": "Eastern Standard Time"
      },
      "westcentralus": {
        "acronym": "uswc",
        "timeDifference": "-7:00",
        "timeZone": "Mountain Standard Time"
      },
      "westeurope": {
        "acronym": "euw",
        "timeDifference": "+1:00",
        "timeZone": "Central Europe Standard Time"
      },
      "westindia": {
        "acronym": "inw",
        "timeDifference": "+5:30",
        "timeZone": "India Standard Time"
      },
      "westus": {
        "acronym": "usw",
        "timeDifference": "-8:00",
        "timeZone": "Pacific Standard Time"
      },
      "westus2": {
        "acronym": "usw2",
        "timeDifference": "-8:00",
        "timeZone": "Pacific Standard Time"
      },
      "westus3": {
        "acronym": "usw3",
        "timeDifference": "-7:00",
        "timeZone": "Mountain Standard Time"
      }
    },
    "MaxResourcesPerTemplateDeployment": 79,
    "DivisionValue": "[div(parameters('SessionHostCount'), variables('MaxResourcesPerTemplateDeployment'))]",
    "DivisionRemainderValue": "[mod(parameters('SessionHostCount'), variables('MaxResourcesPerTemplateDeployment'))]",
    "SessionHostBatchCount": "[if(greater(variables('DivisionRemainderValue'), 0), add(variables('DivisionValue'), 1), variables('DivisionValue'))]",
    "MaxAvSetMembers": 200,
    "BeginAvSetRange": "[div(parameters('SessionHostIndex'), variables('MaxAvSetMembers'))]",
    "EndAvSetRange": "[div(add(parameters('SessionHostCount'), parameters('SessionHostIndex')), variables('MaxAvSetMembers'))]",
    "AvailabilitySetCount": "[length(range(variables('BeginAvSetRange'), add(sub(variables('EndAvSetRange'), variables('BeginAvSetRange')), 1)))]",
    "AppGroupName": "[format('dag-{0}', variables('NamingStandard'))]",
    "AvailabilitySetPrefix": "[format('as-{0}', variables('NamingStandard'))]",
    "AutomationAccountName": "[format('aa-{0}', variables('NamingStandard'))]",
    "DeploymentScriptNamePrefix": "[format('ds-{0}-', variables('NamingStandard'))]",
    "DesktopVirtualizationPowerOnContributorRoleDefinitionResourceId": "[resourceId('Microsoft.Authorization/roleDefinitions', '489581de-a3bd-480d-9518-53dea7416b33')]",
    "DiskEncryptionSetName": "[format('des-{0}', variables('NamingStandard'))]",
    "DiskName": "[format('disk-{0}', variables('NamingStandard'))]",
    "FileShareNames": {
      "CloudCacheProfileContainer": [
        "profile-containers"
      ],
      "CloudCacheProfileOfficeContainer": [
        "office-containers",
        "profile-containers"
      ],
      "ProfileContainer": [
        "profile-containers"
      ],
      "ProfileOfficeContainer": [
        "office-containers",
        "profile-containers"
      ]
    },
    "FileShares": "[variables('FileShareNames')[parameters('FslogixSolution')]]",
    "Fslogix": "[if(or(equals(parameters('FslogixStorage'), 'None'), not(contains(parameters('ActiveDirectorySolution'), 'DomainServices'))), false(), true())]",
    "HostPoolName": "[format('hp-{0}', variables('NamingStandard'))]",
    "KeyVaultName": "[format('kv-{0}', variables('NamingStandard'))]",
    "Locations": "[variables('$fxv#0')]",
    "LocationShortName": "[variables('Locations')[parameters('Location')].acronym]",
    "LogAnalyticsWorkspaceName": "[format('law-{0}', variables('NamingStandard'))]",
    "ManagementVmName": "[format('{0}mgt', variables('VmName'))]",
    "NamingStandard": "[format('{0}-{1}-{2}-{3}', parameters('Identifier'), parameters('Environment'), variables('LocationShortName'), parameters('StampIndex'))]",
    "NetAppAccountName": "[format('naa-{0}', variables('NamingStandard'))]",
    "NetAppCapacityPoolName": "[format('nacp-{0}', variables('NamingStandard'))]",
    "Netbios": "[split(parameters('DomainName'), '.')[0]]",
    "PooledHostPool": "[if(equals(split(parameters('HostPoolType'), ' ')[0], 'Pooled'), true(), false())]",
    "PrivateEndpoint": "[if(contains(parameters('FslogixStorage'), 'PrivateEndpoint'), true(), false())]",
    "ReaderRoleDefinitionResourceId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
    "RecoveryServicesVaultName": "[format('rsv-{0}', variables('NamingStandard'))]",
    "ResourceGroupHosts": "[format('rg-{0}-hosts', variables('NamingStandard'))]",
    "ResourceGroupManagement": "[format('rg-{0}-management', variables('NamingStandard'))]",
    "ResourceGroups": "[if(variables('Fslogix'), createArray(variables('ResourceGroupManagement'), variables('ResourceGroupHosts'), variables('ResourceGroupStorage')), createArray(variables('ResourceGroupManagement'), variables('ResourceGroupHosts')))]",
    "ResourceGroupStorage": "[format('rg-{0}-storage', variables('NamingStandard'))]",
    "SecurityPrincipalIdsCount": "[length(parameters('SecurityPrincipalObjectIds'))]",
    "SecurityPrincipalNamesCount": "[length(parameters('SecurityPrincipalNames'))]",
    "Sentinel": "[if(or(empty(parameters('SentinelLogAnalyticsWorkspaceName')), empty(parameters('SentinelLogAnalyticsWorkspaceResourceGroupName'))), false(), true())]",
    "SentinelResourceGroup": "[if(variables('Sentinel'), parameters('SentinelLogAnalyticsWorkspaceResourceGroupName'), variables('ResourceGroupManagement'))]",
    "StorageAccountPrefix": "[format('st{0}{1}{2}{3}', parameters('Identifier'), parameters('Environment'), variables('LocationShortName'), parameters('StampIndex'))]",
    "StorageSku": "[if(equals(parameters('FslogixStorage'), 'None'), 'None', split(parameters('FslogixStorage'), ' ')[1])]",
    "StorageSolution": "[split(parameters('FslogixStorage'), ' ')[0]]",
    "StorageSuffix": "[environment().suffixes.storage]",
    "UserAssignedIdentityName": "[format('uai-{0}', variables('NamingStandard'))]",
    "VmName": "[format('vm{0}{1}{2}{3}', parameters('Identifier'), parameters('Environment'), variables('LocationShortName'), parameters('StampIndex'))]",
    "VmTemplate": "[format('{{\"domain\":\"{0}\",\"galleryImageOffer\":\"{1}\",\"galleryImagePublisher\":\"{2}\",\"galleryImageSKU\":\"{3}\",\"imageType\":\"Gallery\",\"imageUri\":null,\"customImageId\":null,\"namePrefix\":\"{4}\",\"osDiskType\":\"{5}\",\"useManagedDisks\":true,\"VirtualMachineSize\":{{\"id\":\"{6}\",\"cores\":null,\"ram\":null}},\"galleryItemId\":\"{7}.{8}{9}\"}}', parameters('DomainName'), parameters('ImageOffer'), parameters('ImagePublisher'), parameters('ImageSku'), variables('VmName'), parameters('DiskSku'), parameters('VirtualMachineSize'), parameters('ImagePublisher'), parameters('ImageOffer'), parameters('ImageSku'))]",
    "WorkspaceName": "[format('ws-{0}', variables('NamingStandard'))]"
  },
  "resources": [
    {
      "copy": {
        "name": "resourceGroups",
        "count": "[length(range(0, length(variables('ResourceGroups'))))]"
      },
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2020-10-01",
      "name": "[variables('ResourceGroups')[range(0, length(variables('ResourceGroups')))[copyIndex()]]]",
      "location": "[parameters('Location')]",
      "tags": "[parameters('Tags')]"
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(variables('UserAssignedIdentityName'), variables('ReaderRoleDefinitionResourceId'), subscription().id)]",
      "properties": {
        "roleDefinitionId": "[variables('ReaderRoleDefinitionResourceId')]",
        "principalId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('UserAssignedIdentity_{0}', parameters('Timestamp'))), '2022-09-01').outputs.principalId.value]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('UserAssignedIdentity_{0}', parameters('Timestamp')))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(parameters('AvdObjectId'), variables('DesktopVirtualizationPowerOnContributorRoleDefinitionResourceId'), subscription().id)]",
      "properties": {
        "roleDefinitionId": "[variables('DesktopVirtualizationPowerOnContributorRoleDefinitionResourceId')]",
        "principalId": "[parameters('AvdObjectId')]"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('UserAssignedIdentity_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroupManagement')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "DiskEncryption": {
            "value": "[parameters('DiskEncryption')]"
          },
          "DrainMode": {
            "value": "[parameters('DrainMode')]"
          },
          "Fslogix": {
            "value": "[variables('Fslogix')]"
          },
          "FslogixStorage": {
            "value": "[parameters('FslogixStorage')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "UserAssignedIdentityName": {
            "value": "[variables('UserAssignedIdentityName')]"
          },
          "ResourceGroupStorage": {
            "value": "[variables('ResourceGroupStorage')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "VirtualNetworkResourceGroupName": {
            "value": "[split(parameters('SubnetResourceId'), '/')[4]]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "10897797061386589074"
            }
          },
          "parameters": {
            "DiskEncryption": {
              "type": "bool"
            },
            "DrainMode": {
              "type": "bool"
            },
            "Fslogix": {
              "type": "bool"
            },
            "FslogixStorage": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "ResourceGroupStorage": {
              "type": "string"
            },
            "Timestamp": {
              "type": "string"
            },
            "UserAssignedIdentityName": {
              "type": "string"
            },
            "VirtualNetworkResourceGroupName": {
              "type": "string"
            }
          },
          "variables": {
            "DiskEncryptionRoleAssignment": "[if(parameters('DiskEncryption'), createArray(createObject('roleDefinitionId', '14b46e9e-c2b7-41b4-b07b-48a6ebf60603', 'scope', resourceGroup().name)), createArray())]",
            "DrainModeRoleAssignment": "[if(parameters('DrainMode'), createArray(createObject('roleDefinitionId', '2ad6aaab-ead9-4eaa-8ac5-da422f562408', 'scope', resourceGroup().name)), createArray())]",
            "FSLogixNtfsRoleAssignments": "[if(parameters('Fslogix'), createArray(createObject('roleDefinitionId', 'a959dbd1-f747-45e3-8ba6-dd80f235f97c', 'scope', resourceGroup().name), createObject('roleDefinitionId', '17d1049b-9a84-46fb-8f53-869881c3d3ab', 'scope', parameters('ResourceGroupStorage'))), createArray())]",
            "FSLogixPrivateEndpointRoleAssignment": "[if(contains(parameters('FslogixStorage'), 'PrivateEndpoint'), createArray(createObject('roleDefinitionId', '4d97b98b-1d4f-4787-a291-c67834d212e7', 'scope', parameters('VirtualNetworkResourceGroupName'))), createArray())]",
            "FSLogixRoleAssignments": "[union(variables('FSLogixNtfsRoleAssignments'), variables('FSLogixPrivateEndpointRoleAssignment'))]",
            "RoleAssignments": "[union(variables('DiskEncryptionRoleAssignment'), variables('DrainModeRoleAssignment'), variables('FSLogixRoleAssignments'))]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2018-11-30",
              "name": "[parameters('UserAssignedIdentityName')]",
              "location": "[parameters('Location')]"
            },
            {
              "copy": {
                "name": "roleAssignments",
                "count": "[length(range(0, length(variables('RoleAssignments'))))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('UAI_RoleAssignment_{0}_{1}', range(0, length(variables('RoleAssignments')))[copyIndex()], parameters('Timestamp'))]",
              "resourceGroup": "[variables('RoleAssignments')[range(0, length(variables('RoleAssignments')))[copyIndex()]].scope]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrincipalId": {
                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('UserAssignedIdentityName')), '2018-11-30').principalId]"
                  },
                  "RoleDefinitionId": {
                    "value": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('RoleAssignments')[range(0, length(variables('RoleAssignments')))[copyIndex()]].roleDefinitionId)]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "8096479380248432665"
                    }
                  },
                  "parameters": {
                    "PrincipalId": {
                      "type": "string"
                    },
                    "RoleDefinitionId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "name": "[guid(parameters('PrincipalId'), parameters('RoleDefinitionId'), resourceGroup().id)]",
                      "properties": {
                        "roleDefinitionId": "[parameters('RoleDefinitionId')]",
                        "principalId": "[parameters('PrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('UserAssignedIdentityName'))]"
              ]
            }
          ],
          "outputs": {
            "clientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('UserAssignedIdentityName')), '2018-11-30').clientId]"
            },
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('UserAssignedIdentityName'))]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('UserAssignedIdentityName')), '2018-11-30').principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroups"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('Validations_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroupManagement')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Availability": {
            "value": "[parameters('Availability')]"
          },
          "DeploymentScriptNamePrefix": {
            "value": "[variables('DeploymentScriptNamePrefix')]"
          },
          "DiskSku": {
            "value": "[parameters('DiskSku')]"
          },
          "DomainName": {
            "value": "[variables('DiskName')]"
          },
          "Fslogix": {
            "value": "[variables('Fslogix')]"
          },
          "ActiveDirectorySolution": {
            "value": "[parameters('ActiveDirectorySolution')]"
          },
          "HostPoolType": {
            "value": "[parameters('HostPoolType')]"
          },
          "ImageSku": {
            "value": "[parameters('ImageSku')]"
          },
          "KerberosEncryption": {
            "value": "[parameters('KerberosEncryption')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "SecurityPrincipalIdsCount": {
            "value": "[variables('SecurityPrincipalIdsCount')]"
          },
          "SecurityPrincipalNamesCount": {
            "value": "[variables('SecurityPrincipalNamesCount')]"
          },
          "SessionHostCount": {
            "value": "[parameters('SessionHostCount')]"
          },
          "StorageCount": {
            "value": "[parameters('StorageCount')]"
          },
          "StorageSolution": {
            "value": "[variables('StorageSolution')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "UserAssignedIdentityResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('UserAssignedIdentity_{0}', parameters('Timestamp'))), '2022-09-01').outputs.id.value]"
          },
          "VirtualMachineSize": {
            "value": "[parameters('VirtualMachineSize')]"
          },
          "VnetName": {
            "value": "[split(parameters('SubnetResourceId'), '/')[8]]"
          },
          "VnetResourceGroupName": {
            "value": "[split(parameters('SubnetResourceId'), '/')[4]]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "16163917513805599465"
            }
          },
          "parameters": {
            "ActiveDirectorySolution": {
              "type": "string"
            },
            "Availability": {
              "type": "string"
            },
            "DeploymentScriptNamePrefix": {
              "type": "string"
            },
            "DiskSku": {
              "type": "string"
            },
            "DomainName": {
              "type": "string"
            },
            "Fslogix": {
              "type": "bool"
            },
            "HostPoolType": {
              "type": "string"
            },
            "ImageSku": {
              "type": "string"
            },
            "KerberosEncryption": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "SecurityPrincipalIdsCount": {
              "type": "int"
            },
            "SecurityPrincipalNamesCount": {
              "type": "int"
            },
            "SessionHostCount": {
              "type": "int"
            },
            "StorageCount": {
              "type": "int"
            },
            "StorageSolution": {
              "type": "string"
            },
            "Timestamp": {
              "type": "string"
            },
            "UserAssignedIdentityResourceId": {
              "type": "string"
            },
            "VirtualMachineSize": {
              "type": "string"
            },
            "VnetName": {
              "type": "string"
            },
            "VnetResourceGroupName": {
              "type": "string"
            }
          },
          "variables": {
            "CpuCountMax": "[if(contains(parameters('HostPoolType'), 'Pooled'), 32, 128)]",
            "CpuCountMin": "[if(contains(parameters('HostPoolType'), 'Pooled'), 4, 2)]"
          },
          "resources": [
            {
              "condition": "[greater(parameters('SessionHostCount'), 0)]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('DeploymentScript_AcceleratedNetworkingValidation_{0}', parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Arguments": {
                    "value": "[format('-Location {0} -VmSize {1}', parameters('Location'), parameters('VirtualMachineSize'))]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Name": {
                    "value": "[format('{0}acceleratedNetworkingValidation', parameters('DeploymentScriptNamePrefix'))]"
                  },
                  "Script": {
                    "value": "param([string]$Location,[string]$VmSize); $ErrorActionPreference = \"Stop\"; $Sku = Get-AzComputeResourceSku -Location $Location | Where-Object {$_.ResourceType -eq \"virtualMachines\" -and $_.Name -eq $VmSize}; $DeploymentScriptOutputs = @{}; $DeploymentScriptOutputs[\"enabled\"] = ($Sku.capabilities | Where-Object {$_.name -eq \"AcceleratedNetworkingEnabled\"}).value"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "1338006163064225507"
                    }
                  },
                  "parameters": {
                    "Arguments": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Name": {
                      "type": "string"
                    },
                    "Script": {
                      "type": "string"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('Name')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                        }
                      },
                      "location": "[parameters('Location')]",
                      "kind": "AzurePowerShell",
                      "tags": {},
                      "properties": {
                        "arguments": "[parameters('Arguments')]",
                        "azPowerShellVersion": "9.4",
                        "cleanupPreference": "Always",
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "retentionInterval": "PT2H",
                        "scriptContent": "[parameters('Script')]",
                        "timeout": "PT30M"
                      }
                    }
                  ],
                  "outputs": {
                    "properties": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[equals(parameters('Availability'), 'AvailabilityZones')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('DeploymentScript_AvailabilityZoneValidation_{0}', parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Arguments": {
                    "value": "[format('-Location {0} -VmSize {1}', parameters('Location'), parameters('VirtualMachineSize'))]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Name": {
                    "value": "[format('{0}availabilityZonesValidation', parameters('DeploymentScriptNamePrefix'))]"
                  },
                  "Script": {
                    "value": "param([string]$Location,[string]$VmSize); $ErrorActionPreference = \"Stop\"; $Sku = Get-AzComputeResourceSku -Location $Location | Where-Object {$_.ResourceType -eq \"virtualMachines\" -and $_.Name -eq $VmSize}; $DeploymentScriptOutputs = @{}; $DeploymentScriptOutputs[\"zones\"] = $Sku.locationInfo.zones[0] | Sort-Object | ConvertTo-Json -AsArray"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "1338006163064225507"
                    }
                  },
                  "parameters": {
                    "Arguments": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Name": {
                      "type": "string"
                    },
                    "Script": {
                      "type": "string"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('Name')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                        }
                      },
                      "location": "[parameters('Location')]",
                      "kind": "AzurePowerShell",
                      "tags": {},
                      "properties": {
                        "arguments": "[parameters('Arguments')]",
                        "azPowerShellVersion": "9.4",
                        "cleanupPreference": "Always",
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "retentionInterval": "PT2H",
                        "scriptContent": "[parameters('Script')]",
                        "timeout": "PT30M"
                      }
                    }
                  ],
                  "outputs": {
                    "properties": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[equals(parameters('Availability'), 'AvailabilityZones')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('DeploymentScript_AzureNetAppFilesValidation_{0}', parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Arguments": {
                    "value": "[format('-Location {0} -StorageSolution {1} -VnetName {2} -VnetResourceGroupName {3}', parameters('Location'), parameters('StorageSolution'), parameters('VnetName'), parameters('VnetResourceGroupName'))]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Name": {
                    "value": "[format('{0}azureNetAppFilesValidation', parameters('DeploymentScriptNamePrefix'))]"
                  },
                  "Script": {
                    "value": "param([string]$Location,[string]$StorageSolution,[string]$VnetName,[string]$VnetResourceGroupName); $ErrorActionPreference = \"Stop\"; $DeploymentScriptOutputs = @{}; if($StorageSolution -eq \"AzureNetAppFiles\"){$Vnet = Get-AzVirtualNetwork -Name $VnetName -ResourceGroupName $VnetResourceGroupName; $DnsServers = \"$($Vnet.DhcpOptions.DnsServers[0]),$($Vnet.DhcpOptions.DnsServers[1])\"; $SubnetId = ($Vnet.Subnets | Where-Object {$_.Delegations[0].ServiceName -eq \"Microsoft.NetApp/volumes\"}).Id; if($null -eq $SubnetId -or $SubnetId -eq \"\"){Write-Error -Exception \"INVALID AZURE NETAPP FILES CONFIGURATION: A dedicated subnet must be delegated to the ANF resource provider.\"}; Install-Module -Name \"Az.NetAppFiles\" -Force; $DeployAnfAd = \"true\"; $Accounts = Get-AzResource -ResourceType \"Microsoft.NetApp/netAppAccounts\" | Where-Object {$_.Location -eq $Location}; foreach($Account in $Accounts){$AD = Get-AzNetAppFilesActiveDirectory -ResourceGroupName $Account.ResourceGroupName -AccountName $Account.Name; if($AD.ActiveDirectoryId){$DeployAnfAd = \"false\"}}; $DeploymentScriptOutputs[\"anfDnsServers\"] = $DnsServers; $DeploymentScriptOutputs[\"anfSubnetId\"] = $SubnetId; $DeploymentScriptOutputs[\"anfActiveDirectory\"] = $DeployAnfAd} else {$DeploymentScriptOutputs[\"anfDnsServers\"] = \"NotApplicable\"; $DeploymentScriptOutputs[\"anfSubnetId\"] = \"NotApplicable\"; $DeploymentScriptOutputs[\"anfActiveDirectory\"] = \"false\"}"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "1338006163064225507"
                    }
                  },
                  "parameters": {
                    "Arguments": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Name": {
                      "type": "string"
                    },
                    "Script": {
                      "type": "string"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('Name')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                        }
                      },
                      "location": "[parameters('Location')]",
                      "kind": "AzurePowerShell",
                      "tags": {},
                      "properties": {
                        "arguments": "[parameters('Arguments')]",
                        "azPowerShellVersion": "9.4",
                        "cleanupPreference": "Always",
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "retentionInterval": "PT2H",
                        "scriptContent": "[parameters('Script')]",
                        "timeout": "PT30M"
                      }
                    }
                  ],
                  "outputs": {
                    "properties": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[contains(parameters('DiskSku'), 'Premium')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('DeploymentScript_DiskSkuValidation_{0}', parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Arguments": {
                    "value": "[format('-Location {0} -VmSize {1}', parameters('Location'), parameters('VirtualMachineSize'))]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Name": {
                    "value": "[format('{0}diskSkuValidation', parameters('DeploymentScriptNamePrefix'))]"
                  },
                  "Script": {
                    "value": "param([string]$Location,[string]$VmSize); $ErrorActionPreference = \"Stop\"; $Sku = Get-AzComputeResourceSku -Location $Location | Where-Object {$_.ResourceType -eq \"virtualMachines\" -and $_.Name -eq $VmSize}; if(($Sku.capabilities | Where-Object {$_.name -eq \"PremiumIO\"}).value -eq $false){Write-Error -Exception \"INVALID DISK SKU: The selected VM Size does not support the Premium SKU for managed disks.\"}; $DeploymentScriptOutputs = @{}; $DeploymentScriptOutputs[\"premiumIo\"] = ($Sku.capabilities | Where-Object {$_.name -eq \"PremiumIO\"}).value"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "1338006163064225507"
                    }
                  },
                  "parameters": {
                    "Arguments": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Name": {
                      "type": "string"
                    },
                    "Script": {
                      "type": "string"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('Name')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                        }
                      },
                      "location": "[parameters('Location')]",
                      "kind": "AzurePowerShell",
                      "tags": {},
                      "properties": {
                        "arguments": "[parameters('Arguments')]",
                        "azPowerShellVersion": "9.4",
                        "cleanupPreference": "Always",
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "retentionInterval": "PT2H",
                        "scriptContent": "[parameters('Script')]",
                        "timeout": "PT30M"
                      }
                    }
                  ],
                  "outputs": {
                    "properties": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[or(contains(parameters('ImageSku'), '-g2'), contains(parameters('ImageSku'), 'win11'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('DeploymentScript_HyperVGenerationValidation_{0}', parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Arguments": {
                    "value": "[format('-Location {0} -VmSize {1}', parameters('Location'), parameters('VirtualMachineSize'))]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Name": {
                    "value": "[format('{0}hyperVGenerationValidation', parameters('DeploymentScriptNamePrefix'))]"
                  },
                  "Script": {
                    "value": "param([string]$Location,[string]$VmSize); $ErrorActionPreference = \"Stop\"; $Sku = Get-AzComputeResourceSku -Location $Location | Where-Object {$_.ResourceType -eq \"virtualMachines\" -and $_.Name -eq $VmSize}; if(($Sku.capabilities | Where-Object {$_.name -eq \"HyperVGenerations\"}).value -notlike \"*2\"){Write-Error -Exception \"INVALID HYPER-V GENERATION: The selected VM size does not support the selected Image Sku.\"}; $DeploymentScriptOutputs = @{}; $DeploymentScriptOutputs[\"hyperVGenerations\"] = ($Sku.capabilities | Where-Object {$_.name -eq \"HyperVGenerations\"}).value"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "1338006163064225507"
                    }
                  },
                  "parameters": {
                    "Arguments": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Name": {
                      "type": "string"
                    },
                    "Script": {
                      "type": "string"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('Name')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                        }
                      },
                      "location": "[parameters('Location')]",
                      "kind": "AzurePowerShell",
                      "tags": {},
                      "properties": {
                        "arguments": "[parameters('Arguments')]",
                        "azPowerShellVersion": "9.4",
                        "cleanupPreference": "Always",
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "retentionInterval": "PT2H",
                        "scriptContent": "[parameters('Script')]",
                        "timeout": "PT30M"
                      }
                    }
                  ],
                  "outputs": {
                    "properties": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[equals(parameters('ActiveDirectorySolution'), 'AzureActiveDirectoryDomainServices')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('DeploymentScript_KerberosEncryptionValidation_{0}', parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Arguments": {
                    "value": "[format('-DomainName {0} -KerberosEncryption {1}', parameters('DomainName'), parameters('KerberosEncryption'))]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Name": {
                    "value": "[format('{0}kerberosEncryptionValidation', parameters('DeploymentScriptNamePrefix'))]"
                  },
                  "Script": {
                    "value": "param([string]$DomainName,[string]$KerberosEncryption); $ErrorActionPreference = \"Stop\"; $KerberosRc4Encryption = (Get-AzResource -Name $DomainName -ExpandProperties).Properties.domainSecuritySettings.kerberosRc4Encryption; if($KerberosRc4Encryption -eq \"Enabled\" -and $KerberosEncryption -eq \"AES256\"){Write-Error -Exception \"INVALID KERBEROS ENCRYPTION: The Kerberos Encryption on Azure AD DS does not match your Kerberos Encyrption selection.\"}; $DeploymentScriptOutputs = @{}; $DeploymentScriptOutputs[\"kerberosRc4Encryption\"] = $KerberosRc4Encryption"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "1338006163064225507"
                    }
                  },
                  "parameters": {
                    "Arguments": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Name": {
                      "type": "string"
                    },
                    "Script": {
                      "type": "string"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('Name')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                        }
                      },
                      "location": "[parameters('Location')]",
                      "kind": "AzurePowerShell",
                      "tags": {},
                      "properties": {
                        "arguments": "[parameters('Arguments')]",
                        "azPowerShellVersion": "9.4",
                        "cleanupPreference": "Always",
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "retentionInterval": "PT2H",
                        "scriptContent": "[parameters('Script')]",
                        "timeout": "PT30M"
                      }
                    }
                  ],
                  "outputs": {
                    "properties": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[parameters('Fslogix')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('DeploymentScript_StorageValidation_{0}', parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Arguments": {
                    "value": "[format('-SecurityPrincipalIdsCount {0} -SecurityPrincipalNamesCount {1} -StorageCount {2}', parameters('SecurityPrincipalIdsCount'), parameters('SecurityPrincipalNamesCount'), parameters('StorageCount'))]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Name": {
                    "value": "[format('{0}storageValidation', parameters('DeploymentScriptNamePrefix'))]"
                  },
                  "Script": {
                    "value": "param([int]$SecurityPrincipalIdsCount,[int]$SecurityPrincipalNamesCount,[int]$StorageCount); $ErrorActionPreference = \"Stop\"; if(($StorageCount -ne $SecurityPrincipalIdsCount -or $StorageCount -ne $SecurityPrincipalNamesCount) -and $StorageCount -gt 0){Write-Error -Exception \"INVALID ARRAYS: The \"SecurityPrinicaplIdsCount\", \"SecurityPrincipalNamesCount\", and \"StorageCount\" must be equal in length.\"}; $DeploymentScriptOutputs = @{}; $DeploymentScriptOutputs[\"storageOutOfBounds\"] = ($StorageCount -ne $SecurityPrincipalIdsCount -or $StorageCount -ne $SecurityPrincipalNamesCount) -and $StorageCount -gt 0"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "1338006163064225507"
                    }
                  },
                  "parameters": {
                    "Arguments": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Name": {
                      "type": "string"
                    },
                    "Script": {
                      "type": "string"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('Name')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                        }
                      },
                      "location": "[parameters('Location')]",
                      "kind": "AzurePowerShell",
                      "tags": {},
                      "properties": {
                        "arguments": "[parameters('Arguments')]",
                        "azPowerShellVersion": "9.4",
                        "cleanupPreference": "Always",
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "retentionInterval": "PT2H",
                        "scriptContent": "[parameters('Script')]",
                        "timeout": "PT30M"
                      }
                    }
                  ],
                  "outputs": {
                    "properties": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                    }
                  }
                }
              }
            },
            {
              "condition": "[or(contains(parameters('ImageSku'), '-g2'), contains(parameters('ImageSku'), 'win11'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('DeploymentScript_TrustedLaunchValidation_{0}', parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Arguments": {
                    "value": "[format('-Location {0} -VmSize {1}', parameters('Location'), parameters('VirtualMachineSize'))]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Name": {
                    "value": "[format('{0}trustedLaunchValidation', parameters('DeploymentScriptNamePrefix'))]"
                  },
                  "Script": {
                    "value": "param([string]$Location,[string]$VmSize); $ErrorActionPreference = \"Stop\"; $DeploymentScriptOutputs = @{}; $Sku = Get-AzComputeResourceSku -Location $Location | Where-Object {$_.ResourceType -eq \"virtualMachines\" -and $_.Name -eq $VmSize}; if($null -eq ($Sku.capabilities | Where-Object {$_.name -eq \"TrustedLaunchDisabled\"}).value){$DeploymentScriptOutputs[\"enabled\"] = \"true\"}else{$DeploymentScriptOutputs[\"enabled\"] = \"false\"}"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "1338006163064225507"
                    }
                  },
                  "parameters": {
                    "Arguments": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Name": {
                      "type": "string"
                    },
                    "Script": {
                      "type": "string"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('Name')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                        }
                      },
                      "location": "[parameters('Location')]",
                      "kind": "AzurePowerShell",
                      "tags": {},
                      "properties": {
                        "arguments": "[parameters('Arguments')]",
                        "azPowerShellVersion": "9.4",
                        "cleanupPreference": "Always",
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "retentionInterval": "PT2H",
                        "scriptContent": "[parameters('Script')]",
                        "timeout": "PT30M"
                      }
                    }
                  ],
                  "outputs": {
                    "properties": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('DeploymentScript_CpuCountValidation_{0}', parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Arguments": {
                    "value": "[format('-CpuCountMax {0} -CpuCountMin {1} -Location {2} -VmSize {3}', variables('CpuCountMax'), variables('CpuCountMin'), parameters('Location'), parameters('VirtualMachineSize'))]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Name": {
                    "value": "[format('{0}cpuCountValidation', parameters('DeploymentScriptNamePrefix'))]"
                  },
                  "Script": {
                    "value": "param([int]$CpuCountMax,[int]$CpuCountMin,[string]$Location,[string]$VmSize); $ErrorActionPreference = \"Stop\"; $Sku = Get-AzComputeResourceSku -Location $Location | Where-Object {$_.ResourceType -eq \"virtualMachines\" -and $_.Name -eq $VmSize}; $vCPUs = [int]($Sku.capabilities | Where-Object {$_.name -eq \"vCPUs\"}).value; if($vCPUs -lt $CpuCountMin -or $vCPUs -gt $CpuCountMax){Write-Error -Exception \"INVALID VCPU COUNT: The selected VM Size does not contain the appropriate amount of vCPUs for Azure Virtual Desktop. https://learn.microsoft.com/windows-server/remote/remote-desktop-services/virtual-machine-recs\"}; $DeploymentScriptOutputs = @{}; $DeploymentScriptOutputs[\"vcpus\"] = $vCPUs"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "1338006163064225507"
                    }
                  },
                  "parameters": {
                    "Arguments": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Name": {
                      "type": "string"
                    },
                    "Script": {
                      "type": "string"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('Name')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                        }
                      },
                      "location": "[parameters('Location')]",
                      "kind": "AzurePowerShell",
                      "tags": {},
                      "properties": {
                        "arguments": "[parameters('Arguments')]",
                        "azPowerShellVersion": "9.4",
                        "cleanupPreference": "Always",
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "retentionInterval": "PT2H",
                        "scriptContent": "[parameters('Script')]",
                        "timeout": "PT30M"
                      }
                    }
                  ],
                  "outputs": {
                    "properties": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('DeploymentScript_CpuQuotaValidation_{0}', parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Arguments": {
                    "value": "[format('-Location {0} -SessionHostCount {1} -VmSize {2}', parameters('Location'), parameters('SessionHostCount'), parameters('VirtualMachineSize'))]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Name": {
                    "value": "[format('{0}cpuQuotaValidation', parameters('DeploymentScriptNamePrefix'))]"
                  },
                  "Script": {
                    "value": "param([string]$Location,[int]$SessionHostCount,[string]$VmSize); $ErrorActionPreference = \"Stop\"; $Sku = Get-AzComputeResourceSku -Location $Location | Where-Object {$_.ResourceType -eq \"virtualMachines\" -and $_.Name -eq $VmSize}; $vCPUs = [int]($Sku.capabilities | Where-Object {$_.name -eq \"vCPUs\"}).value; $RequestedCores = $vCPUs * $SessionHostCount; $Family = (Get-AzComputeResourceSku -Location $Location | Where-Object {$_.Name -eq $VmSize}).Family; $CpuData = Get-AzVMUsage -Location $Location | Where-Object {$_.Name.Value -eq $Family}; $AvailableCores = $CpuData.Limit - $CpuData.CurrentValue; $RequestedCores = $vCPUs * $SessionHostCount; if($RequestedCores -gt $AvailableCores){Write-Error -Exception \"INSUFFICIENT CORE QUOTA: The selected VM size, $VmSize, does not have adequate core quota in the selected location.\"}; $DeploymentScriptOutputs = @{}; $DeploymentScriptOutputs[\"requestedCores\"] = $RequestedCores; $DeploymentScriptOutputs[\"availableCores\"] = $AvailableCores"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "1338006163064225507"
                    }
                  },
                  "parameters": {
                    "Arguments": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Name": {
                      "type": "string"
                    },
                    "Script": {
                      "type": "string"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('Name')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                        }
                      },
                      "location": "[parameters('Location')]",
                      "kind": "AzurePowerShell",
                      "tags": {},
                      "properties": {
                        "arguments": "[parameters('Arguments')]",
                        "azPowerShellVersion": "9.4",
                        "cleanupPreference": "Always",
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "retentionInterval": "PT2H",
                        "scriptContent": "[parameters('Script')]",
                        "timeout": "PT30M"
                      }
                    }
                  ],
                  "outputs": {
                    "properties": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "acceleratedNetworking": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', format('DeploymentScript_AcceleratedNetworkingValidation_{0}', parameters('Timestamp'))), '2022-09-01').outputs.properties.value.enabled]"
            },
            "anfActiveDirectory": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', format('DeploymentScript_AzureNetAppFilesValidation_{0}', parameters('Timestamp'))), '2022-09-01').outputs.properties.value.anfActiveDirectory]"
            },
            "anfDnsServers": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', format('DeploymentScript_AzureNetAppFilesValidation_{0}', parameters('Timestamp'))), '2022-09-01').outputs.properties.value.anfDnsServers]"
            },
            "anfSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', format('DeploymentScript_AzureNetAppFilesValidation_{0}', parameters('Timestamp'))), '2022-09-01').outputs.properties.value.anfSubnetId]"
            },
            "availabilityZones": {
              "type": "array",
              "value": "[if(equals(parameters('Availability'), 'AvailabilityZones'), json(reference(resourceId('Microsoft.Resources/deployments', format('DeploymentScript_AvailabilityZoneValidation_{0}', parameters('Timestamp'))), '2022-09-01').outputs.properties.value.zones), createArray('1'))]"
            },
            "trustedLaunch": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Resources/deployments', format('DeploymentScript_TrustedLaunchValidation_{0}', parameters('Timestamp'))), '2022-09-01').outputs.properties.value.enabled]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroups",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('UserAssignedIdentity_{0}', parameters('Timestamp')))]"
      ]
    },
    {
      "condition": "[variables('PooledHostPool')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('AutomationAccount_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroupManagement')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AutomationAccountName": {
            "value": "[variables('AutomationAccountName')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "LogAnalyticsWorkspaceResourceId": "[if(parameters('Monitoring'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Monitoring_{0}', parameters('Timestamp'))), '2022-09-01').outputs.ResourceId.value), createObject('value', ''))]",
          "Monitoring": {
            "value": "[parameters('Monitoring')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "8959663989136364503"
            }
          },
          "parameters": {
            "AutomationAccountName": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "LogAnalyticsWorkspaceResourceId": {
              "type": "string"
            },
            "Monitoring": {
              "type": "bool"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Automation/automationAccounts",
              "apiVersion": "2021-06-22",
              "name": "[parameters('AutomationAccountName')]",
              "location": "[parameters('Location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "sku": {
                  "name": "Free"
                }
              }
            },
            {
              "condition": "[parameters('Monitoring')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2017-05-01-preview",
              "scope": "[format('Microsoft.Automation/automationAccounts/{0}', parameters('AutomationAccountName'))]",
              "name": "[format('diag-{0}', parameters('AutomationAccountName'))]",
              "properties": {
                "logs": [
                  {
                    "category": "DscNodeStatus",
                    "enabled": true
                  },
                  {
                    "category": "JobLogs",
                    "enabled": true
                  },
                  {
                    "category": "JobStreams",
                    "enabled": true
                  }
                ],
                "workspaceId": "[parameters('LogAnalyticsWorkspaceResourceId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', parameters('AutomationAccountName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Monitoring_{0}', parameters('Timestamp')))]",
        "resourceGroups"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('HostPool_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroupManagement')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AppGroupName": {
            "value": "[variables('AppGroupName')]"
          },
          "CustomRdpProperty": {
            "value": "[parameters('CustomRdpProperty')]"
          },
          "ActiveDirectorySolution": {
            "value": "[parameters('ActiveDirectorySolution')]"
          },
          "HostPoolName": {
            "value": "[variables('HostPoolName')]"
          },
          "HostPoolType": {
            "value": "[parameters('HostPoolType')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "LogAnalyticsWorkspaceResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Monitoring_{0}', parameters('Timestamp'))), '2022-09-01').outputs.ResourceId.value]"
          },
          "MaxSessionLimit": {
            "value": "[parameters('MaxSessionLimit')]"
          },
          "SecurityPrincipalIds": {
            "value": "[parameters('SecurityPrincipalObjectIds')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "ValidationEnvironment": {
            "value": "[parameters('ValidationEnvironment')]"
          },
          "VmTemplate": {
            "value": "[variables('VmTemplate')]"
          },
          "WorkspaceName": {
            "value": "[variables('WorkspaceName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "9881481074649894650"
            }
          },
          "parameters": {
            "AppGroupName": {
              "type": "string"
            },
            "CustomRdpProperty": {
              "type": "string"
            },
            "ActiveDirectorySolution": {
              "type": "string"
            },
            "HostPoolName": {
              "type": "string"
            },
            "HostPoolType": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "LogAnalyticsWorkspaceResourceId": {
              "type": "string"
            },
            "MaxSessionLimit": {
              "type": "int"
            },
            "SecurityPrincipalIds": {
              "type": "array"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string",
              "defaultValue": "[utcNow('u')]"
            },
            "ValidationEnvironment": {
              "type": "bool"
            },
            "VmTemplate": {
              "type": "string"
            },
            "WorkspaceName": {
              "type": "string"
            }
          },
          "variables": {
            "CustomRdpProperty_Complete": "[if(or(equals(parameters('ActiveDirectorySolution'), 'AzureActiveDirectory'), equals(parameters('ActiveDirectorySolution'), 'AzureActiveDirectoryIntuneEnrollment')), format('{0}targetisaadjoined:i:1', parameters('CustomRdpProperty')), parameters('CustomRdpProperty'))]",
            "DesktopVirtualizationUserRoleDefinitionResourceId": "[resourceId('Microsoft.Authorization/roleDefinitions', '1d18fff3-a72a-46b5-b4a9-0b38a3cd7e63')]",
            "HostPoolLogs": [
              {
                "category": "Checkpoint",
                "enabled": true
              },
              {
                "category": "Error",
                "enabled": true
              },
              {
                "category": "Management",
                "enabled": true
              },
              {
                "category": "Connection",
                "enabled": true
              },
              {
                "category": "HostRegistration",
                "enabled": true
              },
              {
                "category": "AgentHealthStatus",
                "enabled": true
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.DesktopVirtualization/hostPools",
              "apiVersion": "2021-03-09-preview",
              "name": "[parameters('HostPoolName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "hostPoolType": "[split(parameters('HostPoolType'), ' ')[0]]",
                "maxSessionLimit": "[parameters('MaxSessionLimit')]",
                "loadBalancerType": "[if(contains(parameters('HostPoolType'), 'Pooled'), split(parameters('HostPoolType'), ' ')[1], 'Persistent')]",
                "validationEnvironment": "[parameters('ValidationEnvironment')]",
                "registrationInfo": {
                  "expirationTime": "[dateTimeAdd(parameters('Timestamp'), 'PT2H')]",
                  "registrationTokenOperation": "Update"
                },
                "preferredAppGroupType": "Desktop",
                "customRdpProperty": "[variables('CustomRdpProperty_Complete')]",
                "personalDesktopAssignmentType": "[if(contains(parameters('HostPoolType'), 'Personal'), split(parameters('HostPoolType'), ' ')[1], null())]",
                "startVMOnConnect": true,
                "vmTemplate": "[parameters('VmTemplate')]"
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.DesktopVirtualization/hostPools/{0}', parameters('HostPoolName'))]",
              "name": "[format('diag-{0}', parameters('HostPoolName'))]",
              "properties": {
                "logs": "[variables('HostPoolLogs')]",
                "workspaceId": "[parameters('LogAnalyticsWorkspaceResourceId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('HostPoolName'))]"
              ]
            },
            {
              "type": "Microsoft.DesktopVirtualization/applicationGroups",
              "apiVersion": "2021-03-09-preview",
              "name": "[parameters('AppGroupName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "hostPoolArmPath": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('HostPoolName'))]",
                "applicationGroupType": "Desktop"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('HostPoolName'))]"
              ]
            },
            {
              "copy": {
                "name": "appGroupAssignment",
                "count": "[length(range(0, length(parameters('SecurityPrincipalIds'))))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.DesktopVirtualization/applicationGroups/{0}', parameters('AppGroupName'))]",
              "name": "[guid(parameters('SecurityPrincipalIds')[range(0, length(parameters('SecurityPrincipalIds')))[copyIndex()]], variables('DesktopVirtualizationUserRoleDefinitionResourceId'), parameters('AppGroupName'))]",
              "properties": {
                "roleDefinitionId": "[variables('DesktopVirtualizationUserRoleDefinitionResourceId')]",
                "principalId": "[parameters('SecurityPrincipalIds')[range(0, length(parameters('SecurityPrincipalIds')))[copyIndex()]]]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('AppGroupName'))]"
              ]
            },
            {
              "type": "Microsoft.DesktopVirtualization/workspaces",
              "apiVersion": "2021-03-09-preview",
              "name": "[parameters('WorkspaceName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "applicationGroupReferences": [
                  "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('AppGroupName'))]"
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('AppGroupName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.DesktopVirtualization/workspaces/{0}', parameters('WorkspaceName'))]",
              "name": "[format('diag-{0}', parameters('WorkspaceName'))]",
              "properties": {
                "logs": [
                  {
                    "category": "Checkpoint",
                    "enabled": true
                  },
                  {
                    "category": "Error",
                    "enabled": true
                  },
                  {
                    "category": "Management",
                    "enabled": true
                  },
                  {
                    "category": "Feed",
                    "enabled": true
                  }
                ],
                "workspaceId": "[parameters('LogAnalyticsWorkspaceResourceId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/workspaces', parameters('WorkspaceName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Monitoring_{0}', parameters('Timestamp')))]",
        "resourceGroups"
      ]
    },
    {
      "condition": "[parameters('Monitoring')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('Monitoring_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroupManagement')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "LogAnalyticsWorkspaceName": {
            "value": "[variables('LogAnalyticsWorkspaceName')]"
          },
          "LogAnalyticsWorkspaceRetention": {
            "value": "[parameters('LogAnalyticsWorkspaceRetention')]"
          },
          "LogAnalyticsWorkspaceSku": {
            "value": "[parameters('LogAnalyticsWorkspaceSku')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "5541549134855312111"
            }
          },
          "parameters": {
            "Location": {
              "type": "string"
            },
            "LogAnalyticsWorkspaceName": {
              "type": "string"
            },
            "LogAnalyticsWorkspaceRetention": {
              "type": "int"
            },
            "LogAnalyticsWorkspaceSku": {
              "type": "string"
            },
            "Tags": {
              "type": "object"
            }
          },
          "variables": {
            "WindowsEvents": [
              {
                "name": "Microsoft-FSLogix-Apps/Operational",
                "types": [
                  {
                    "eventType": "Error"
                  },
                  {
                    "eventType": "Warning"
                  },
                  {
                    "eventType": "Information"
                  }
                ]
              },
              {
                "name": "Microsoft-Windows-TerminalServices-LocalSessionManager/Operational",
                "types": [
                  {
                    "eventType": "Error"
                  },
                  {
                    "eventType": "Warning"
                  },
                  {
                    "eventType": "Information"
                  }
                ]
              },
              {
                "name": "System",
                "types": [
                  {
                    "eventType": "Error"
                  },
                  {
                    "eventType": "Warning"
                  }
                ]
              },
              {
                "name": "Microsoft-Windows-TerminalServices-RemoteConnectionManager/Admin",
                "types": [
                  {
                    "eventType": "Error"
                  },
                  {
                    "eventType": "Warning"
                  },
                  {
                    "eventType": "Information"
                  }
                ]
              },
              {
                "name": "Microsoft-FSLogix-Apps/Admin",
                "types": [
                  {
                    "eventType": "Error"
                  },
                  {
                    "eventType": "Warning"
                  },
                  {
                    "eventType": "Information"
                  }
                ]
              },
              {
                "name": "Application",
                "types": [
                  {
                    "eventType": "Error"
                  },
                  {
                    "eventType": "Warning"
                  }
                ]
              }
            ],
            "WindowsPerformanceCounters": [
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Disk Transfers/sec"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Current Disk Queue Length"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Disk Reads/sec"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "% Free Space"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk sec/Read"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Disk Writes/sec"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk sec/Write"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Free Megabytes"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "C:",
                "intervalSeconds": 60,
                "counterName": "% Free Space"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "C:",
                "intervalSeconds": 30,
                "counterName": "Avg. Disk Queue Length"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "C:",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk sec/Transfer"
              },
              {
                "objectName": "LogicalDisk",
                "instanceName": "C:",
                "intervalSeconds": 30,
                "counterName": "Current Disk Queue Length"
              },
              {
                "objectName": "Memory",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "% Committed Bytes In Use"
              },
              {
                "objectName": "Memory",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Available MBytes"
              },
              {
                "objectName": "Memory",
                "instanceName": "*",
                "intervalSeconds": 30,
                "counterName": "Available Mbytes"
              },
              {
                "objectName": "Memory",
                "instanceName": "*",
                "intervalSeconds": 30,
                "counterName": "Page Faults/sec"
              },
              {
                "objectName": "Memory",
                "instanceName": "*",
                "intervalSeconds": 30,
                "counterName": "Pages/sec"
              },
              {
                "objectName": "Network Adapter",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Bytes Sent/sec"
              },
              {
                "objectName": "Network Adapter",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Bytes Received/sec"
              },
              {
                "objectName": "Network Interface",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Bytes Total/sec"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk Bytes/Transfer"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk Bytes/Read"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk sec/Write"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk sec/Read"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk Bytes/Write"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Avg. Disk sec/Transfer"
              },
              {
                "objectName": "PhysicalDisk",
                "instanceName": "*",
                "intervalSeconds": 30,
                "counterName": "Avg. Disk Queue Length"
              },
              {
                "objectName": "Process",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "IO Write Operations/sec"
              },
              {
                "objectName": "Process",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "IO Read Operations/sec"
              },
              {
                "objectName": "Process",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Thread Count"
              },
              {
                "objectName": "Process",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "% User Time"
              },
              {
                "objectName": "Process",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Working Set"
              },
              {
                "objectName": "Process",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "% Processor Time"
              },
              {
                "objectName": "Processor",
                "instanceName": "_Total",
                "intervalSeconds": 60,
                "counterName": "% Processor Time"
              },
              {
                "objectName": "Processor Information",
                "instanceName": "_Total",
                "intervalSeconds": 30,
                "counterName": "% Processor Time"
              },
              {
                "objectName": "RemoteFX Graphics",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Frames Skipped/Second - Insufficient Server Resources"
              },
              {
                "objectName": "RemoteFX Graphics",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Average Encoding Time"
              },
              {
                "objectName": "RemoteFX Graphics",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Frames Skipped/Second - Insufficient Client Resources"
              },
              {
                "objectName": "RemoteFX Graphics",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Frames Skipped/Second - Insufficient Network Resources"
              },
              {
                "objectName": "RemoteFX Network",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Current UDP Bandwidth"
              },
              {
                "objectName": "RemoteFX Network",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Current TCP Bandwidth"
              },
              {
                "objectName": "RemoteFX Network",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Current TCP RTT"
              },
              {
                "objectName": "RemoteFX Network",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Current UDP RTT"
              },
              {
                "objectName": "System",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Processor Queue Length"
              },
              {
                "objectName": "Terminal Services",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Inactive Sessions"
              },
              {
                "objectName": "Terminal Services",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Total Sessions"
              },
              {
                "objectName": "Terminal Services",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "Active Sessions"
              },
              {
                "objectName": "Terminal Services Session",
                "instanceName": "*",
                "intervalSeconds": 60,
                "counterName": "% Processor Time"
              },
              {
                "objectName": "User Input Delay per Process",
                "instanceName": "*",
                "intervalSeconds": 30,
                "counterName": "Max Input Delay"
              },
              {
                "objectName": "User Input Delay per Session",
                "instanceName": "*",
                "intervalSeconds": 30,
                "counterName": "Max Input Delay"
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2021-06-01",
              "name": "[parameters('LogAnalyticsWorkspaceName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "sku": {
                  "name": "[parameters('LogAnalyticsWorkspaceSku')]"
                },
                "retentionInDays": "[parameters('LogAnalyticsWorkspaceRetention')]",
                "workspaceCapping": {
                  "dailyQuotaGb": -1
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            },
            {
              "copy": {
                "name": "windowsEvents",
                "count": "[length(variables('WindowsEvents'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.OperationalInsights/workspaces/dataSources",
              "apiVersion": "2020-08-01",
              "name": "[format('{0}/{1}', parameters('LogAnalyticsWorkspaceName'), format('WindowsEvent{0}', copyIndex()))]",
              "tags": "[parameters('Tags')]",
              "kind": "WindowsEvent",
              "properties": {
                "eventLogName": "[variables('WindowsEvents')[copyIndex()].name]",
                "eventTypes": "[variables('WindowsEvents')[copyIndex()].types]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsWorkspaceName'))]"
              ]
            },
            {
              "copy": {
                "name": "windowsPerformanceCounters",
                "count": "[length(variables('WindowsPerformanceCounters'))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.OperationalInsights/workspaces/dataSources",
              "apiVersion": "2020-08-01",
              "name": "[format('{0}/{1}', parameters('LogAnalyticsWorkspaceName'), format('WindowsPerformanceCounter{0}', copyIndex()))]",
              "tags": "[parameters('Tags')]",
              "kind": "WindowsPerformanceCounter",
              "properties": {
                "objectName": "[variables('WindowsPerformanceCounters')[copyIndex()].objectName]",
                "instanceName": "[variables('WindowsPerformanceCounters')[copyIndex()].instanceName]",
                "intervalSeconds": "[variables('WindowsPerformanceCounters')[copyIndex()].intervalSeconds]",
                "counterName": "[variables('WindowsPerformanceCounters')[copyIndex()].counterName]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsWorkspaceName'))]",
                "windowsEvents"
              ]
            }
          ],
          "outputs": {
            "ResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsWorkspaceName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroups"
      ]
    },
    {
      "condition": "[parameters('DiskEncryption')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('DiskEncryption_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroupManagement')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "DeploymentScriptNamePrefix": {
            "value": "[variables('DeploymentScriptNamePrefix')]"
          },
          "DiskEncryptionSetName": {
            "value": "[variables('DiskEncryptionSetName')]"
          },
          "Environment": {
            "value": "[parameters('Environment')]"
          },
          "KeyVaultName": {
            "value": "[variables('KeyVaultName')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "UserAssignedIdentityPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('UserAssignedIdentity_{0}', parameters('Timestamp'))), '2022-09-01').outputs.principalId.value]"
          },
          "UserAssignedIdentityResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('UserAssignedIdentity_{0}', parameters('Timestamp'))), '2022-09-01').outputs.id.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "11682136833731218422"
            }
          },
          "parameters": {
            "DeploymentScriptNamePrefix": {
              "type": "string"
            },
            "DiskEncryptionKeyExpirationInDays": {
              "type": "int",
              "defaultValue": 30
            },
            "DiskEncryptionSetName": {
              "type": "string"
            },
            "Environment": {
              "type": "string"
            },
            "KeyVaultName": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string"
            },
            "UserAssignedIdentityPrincipalId": {
              "type": "string"
            },
            "UserAssignedIdentityResourceId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2022-07-01",
              "name": "[parameters('KeyVaultName')]",
              "location": "[parameters('Location')]",
              "tags": {},
              "properties": {
                "enabledForDeployment": false,
                "enabledForDiskEncryption": true,
                "enabledForTemplateDeployment": false,
                "enablePurgeProtection": true,
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "softDeleteRetentionInDays": "[if(or(equals(parameters('Environment'), 'd'), equals(parameters('Environment'), 't')), 7, 90)]",
                "tenantId": "[subscription().tenantId]"
              }
            },
            {
              "type": "Microsoft.Compute/diskEncryptionSets",
              "apiVersion": "2022-07-02",
              "name": "[parameters('DiskEncryptionSetName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                }
              },
              "properties": {
                "activeKey": {
                  "sourceVault": {
                    "id": "[resourceId('Microsoft.KeyVault/vaults', parameters('KeyVaultName'))]"
                  },
                  "keyUrl": "[reference(resourceId('Microsoft.Resources/deployments', 'DiskEncryptionKey'), '2022-09-01').outputs.keyUriWithVersion.value]"
                },
                "encryptionType": "EncryptionAtRestWithPlatformAndCustomerKeys",
                "federatedClientId": "None",
                "rotationToLatestKeyVersionEnabled": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'DiskEncryptionKey')]",
                "[resourceId('Microsoft.KeyVault/vaults', parameters('KeyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('DeploymentScript_DiskEncryptionKeyValidation_{0}', parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Arguments": {
                    "value": "[format('-VaultName {0}', parameters('KeyVaultName'))]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "Name": {
                    "value": "[format('{0}diskEncryptionKeyValidation', parameters('DeploymentScriptNamePrefix'))]"
                  },
                  "Script": {
                    "value": "param([string]$VaultName); $ErrorActionPreference = \"Stop\"; $Key = Get-AzKeyVaultKey -VaultName $VaultName | Where-Object {$_.Name -eq \"DiskEncryptionKey\"}; $DeploymentScriptOutputs = @{}; if($Key){$Exists = \"True\"}else{$Exists = \"False\"}; $DeploymentScriptOutputs[\"exists\"] = $Exists"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "1338006163064225507"
                    }
                  },
                  "parameters": {
                    "Arguments": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "Name": {
                      "type": "string"
                    },
                    "Script": {
                      "type": "string"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[parameters('Name')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                        }
                      },
                      "location": "[parameters('Location')]",
                      "kind": "AzurePowerShell",
                      "tags": {},
                      "properties": {
                        "arguments": "[parameters('Arguments')]",
                        "azPowerShellVersion": "9.4",
                        "cleanupPreference": "Always",
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "retentionInterval": "PT2H",
                        "scriptContent": "[parameters('Script')]",
                        "timeout": "PT30M"
                      }
                    }
                  ],
                  "outputs": {
                    "properties": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('KeyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "DiskEncryptionKey",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "DiskEncryptionKeyExpirationInDays": {
                    "value": "[parameters('DiskEncryptionKeyExpirationInDays')]"
                  },
                  "KeyDoesNotExist": {
                    "value": "[equals(reference(resourceId('Microsoft.Resources/deployments', format('DeploymentScript_DiskEncryptionKeyValidation_{0}', parameters('Timestamp'))), '2022-09-01').outputs.properties.value.exists, 'False')]"
                  },
                  "KeyVaultName": {
                    "value": "[parameters('KeyVaultName')]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "5430955873971378064"
                    }
                  },
                  "parameters": {
                    "DiskEncryptionKeyExpirationInDays": {
                      "type": "int"
                    },
                    "KeyDoesNotExist": {
                      "type": "bool"
                    },
                    "KeyVaultName": {
                      "type": "string"
                    },
                    "Tags": {
                      "type": "object"
                    },
                    "Time": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "DiskEncryptionKeyExpirationInEpoch": "[dateTimeToEpoch(dateTimeAdd(parameters('Time'), format('P{0}D', string(parameters('DiskEncryptionKeyExpirationInDays')))))]"
                  },
                  "resources": [
                    {
                      "condition": "[parameters('KeyDoesNotExist')]",
                      "type": "Microsoft.KeyVault/vaults/keys",
                      "apiVersion": "2022-07-01",
                      "name": "[format('{0}/{1}', parameters('KeyVaultName'), 'DiskEncryptionKey')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "attributes": {
                          "enabled": true,
                          "exp": "[variables('DiskEncryptionKeyExpirationInEpoch')]",
                          "nbf": null
                        },
                        "keySize": 4096,
                        "kty": "RSA",
                        "rotationPolicy": {
                          "attributes": {
                            "expiryTime": "[format('P{0}D', string(parameters('DiskEncryptionKeyExpirationInDays')))]"
                          },
                          "lifetimeActions": [
                            {
                              "action": {
                                "type": "notify"
                              },
                              "trigger": {
                                "timeBeforeExpiry": "P10D"
                              }
                            },
                            {
                              "action": {
                                "type": "rotate"
                              },
                              "trigger": {
                                "timeAfterCreate": "[format('P{0}D', string(sub(parameters('DiskEncryptionKeyExpirationInDays'), 7)))]"
                              }
                            }
                          ]
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "keyUriWithVersion": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.KeyVault/vaults/keys', parameters('KeyVaultName'), 'DiskEncryptionKey'), '2022-07-01').keyUriWithVersion]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', format('DeploymentScript_DiskEncryptionKeyValidation_{0}', parameters('Timestamp')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('RoleAssignment_{0}', parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrincipalId": {
                    "value": "[parameters('UserAssignedIdentityPrincipalId')]"
                  },
                  "RoleDefinitionId": {
                    "value": "[resourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "8096479380248432665"
                    }
                  },
                  "parameters": {
                    "PrincipalId": {
                      "type": "string"
                    },
                    "RoleDefinitionId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "name": "[guid(parameters('PrincipalId'), parameters('RoleDefinitionId'), resourceGroup().id)]",
                      "properties": {
                        "roleDefinitionId": "[parameters('RoleDefinitionId')]",
                        "principalId": "[parameters('PrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ]
                }
              }
            }
          ],
          "outputs": {
            "diskEncryptionSetResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/diskEncryptionSets', parameters('DiskEncryptionSetName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('UserAssignedIdentity_{0}', parameters('Timestamp')))]"
      ]
    },
    {
      "condition": "[variables('Fslogix')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('FSLogix_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroupManagement')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "Availability": {
            "value": "[parameters('Availability')]"
          },
          "ActiveDirectoryConnection": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Validations_{0}', parameters('Timestamp'))), '2022-09-01').outputs.anfActiveDirectory.value]"
          },
          "AzureFilesPrivateDnsZoneResourceId": {
            "value": "[parameters('AzureFilesPrivateDnsZoneResourceId')]"
          },
          "ClientId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('UserAssignedIdentity_{0}', parameters('Timestamp'))), '2022-09-01').outputs.clientId.value]"
          },
          "DelegatedSubnetId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Validations_{0}', parameters('Timestamp'))), '2022-09-01').outputs.anfSubnetId.value]"
          },
          "DeploymentScriptNamePrefix": {
            "value": "[variables('DeploymentScriptNamePrefix')]"
          },
          "DiskEncryption": {
            "value": "[parameters('DiskEncryption')]"
          },
          "DiskEncryptionSetResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('DiskEncryption_{0}', parameters('Timestamp'))), '2022-09-01').outputs.diskEncryptionSetResourceId.value]"
          },
          "DiskSku": {
            "value": "[parameters('DiskSku')]"
          },
          "DnsServers": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Validations_{0}', parameters('Timestamp'))), '2022-09-01').outputs.anfDnsServers.value]"
          },
          "DomainJoinPassword": {
            "value": "[parameters('DomainJoinPassword')]"
          },
          "DomainJoinUserPrincipalName": {
            "value": "[parameters('DomainJoinUserPrincipalName')]"
          },
          "DomainName": {
            "value": "[parameters('DomainName')]"
          },
          "ActiveDirectorySolution": {
            "value": "[parameters('ActiveDirectorySolution')]"
          },
          "FileShares": {
            "value": "[variables('FileShares')]"
          },
          "FslogixShareSizeInGB": {
            "value": "[parameters('FslogixShareSizeInGB')]"
          },
          "FslogixSolution": {
            "value": "[parameters('FslogixSolution')]"
          },
          "FslogixStorage": {
            "value": "[parameters('FslogixStorage')]"
          },
          "KerberosEncryption": {
            "value": "[parameters('KerberosEncryption')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "ManagementVmName": {
            "value": "[variables('ManagementVmName')]"
          },
          "NamingStandard": {
            "value": "[variables('NamingStandard')]"
          },
          "NetAppAccountName": {
            "value": "[variables('NetAppAccountName')]"
          },
          "NetAppCapacityPoolName": {
            "value": "[variables('NetAppCapacityPoolName')]"
          },
          "Netbios": {
            "value": "[variables('Netbios')]"
          },
          "OuPath": {
            "value": "[parameters('OuPath')]"
          },
          "PrivateEndpoint": {
            "value": "[variables('PrivateEndpoint')]"
          },
          "ResourceGroupManagement": {
            "value": "[variables('ResourceGroupManagement')]"
          },
          "ResourceGroupStorage": {
            "value": "[variables('ResourceGroupStorage')]"
          },
          "SecurityPrincipalIds": {
            "value": "[parameters('SecurityPrincipalObjectIds')]"
          },
          "SecurityPrincipalNames": {
            "value": "[parameters('SecurityPrincipalNames')]"
          },
          "SmbServerLocation": {
            "value": "[variables('LocationShortName')]"
          },
          "StorageAccountPrefix": {
            "value": "[variables('StorageAccountPrefix')]"
          },
          "StorageCount": {
            "value": "[parameters('StorageCount')]"
          },
          "StorageIndex": {
            "value": "[parameters('StorageIndex')]"
          },
          "StorageSku": {
            "value": "[variables('StorageSku')]"
          },
          "StorageSolution": {
            "value": "[variables('StorageSolution')]"
          },
          "Subnet": {
            "value": "[split(parameters('SubnetResourceId'), '/')[10]]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "TrustedLaunch": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Validations_{0}', parameters('Timestamp'))), '2022-09-01').outputs.trustedLaunch.value]"
          },
          "UserAssignedIdentityResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('UserAssignedIdentity_{0}', parameters('Timestamp'))), '2022-09-01').outputs.id.value]"
          },
          "VirtualNetwork": {
            "value": "[split(parameters('SubnetResourceId'), '/')[8]]"
          },
          "VirtualNetworkResourceGroup": {
            "value": "[split(parameters('SubnetResourceId'), '/')[4]]"
          },
          "VirtualMachinePassword": {
            "value": "[parameters('VirtualMachinePassword')]"
          },
          "VirtualMachineUsername": {
            "value": "[parameters('VirtualMachineUsername')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "5801181954516804566"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string"
            },
            "_artifactsLocationSasToken": {
              "type": "securestring"
            },
            "ActiveDirectoryConnection": {
              "type": "string"
            },
            "ActiveDirectorySolution": {
              "type": "string"
            },
            "Availability": {
              "type": "string"
            },
            "AzureFilesPrivateDnsZoneResourceId": {
              "type": "string"
            },
            "ClientId": {
              "type": "string"
            },
            "DelegatedSubnetId": {
              "type": "string"
            },
            "DeploymentScriptNamePrefix": {
              "type": "string"
            },
            "DiskEncryption": {
              "type": "bool"
            },
            "DiskEncryptionSetResourceId": {
              "type": "string"
            },
            "DiskSku": {
              "type": "string"
            },
            "DnsServers": {
              "type": "string"
            },
            "DomainJoinPassword": {
              "type": "securestring"
            },
            "DomainJoinUserPrincipalName": {
              "type": "string"
            },
            "DomainName": {
              "type": "string"
            },
            "FileShares": {
              "type": "array"
            },
            "FslogixShareSizeInGB": {
              "type": "int"
            },
            "FslogixSolution": {
              "type": "string"
            },
            "FslogixStorage": {
              "type": "string"
            },
            "KerberosEncryption": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "ManagementVmName": {
              "type": "string"
            },
            "NamingStandard": {
              "type": "string"
            },
            "NetAppAccountName": {
              "type": "string"
            },
            "NetAppCapacityPoolName": {
              "type": "string"
            },
            "Netbios": {
              "type": "string"
            },
            "OuPath": {
              "type": "string"
            },
            "PrivateEndpoint": {
              "type": "bool"
            },
            "ResourceGroupManagement": {
              "type": "string"
            },
            "ResourceGroupStorage": {
              "type": "string"
            },
            "SecurityPrincipalIds": {
              "type": "array"
            },
            "SecurityPrincipalNames": {
              "type": "array"
            },
            "SmbServerLocation": {
              "type": "string"
            },
            "StorageAccountPrefix": {
              "type": "string"
            },
            "StorageCount": {
              "type": "int"
            },
            "StorageIndex": {
              "type": "int"
            },
            "StorageSku": {
              "type": "string"
            },
            "StorageSolution": {
              "type": "string"
            },
            "Subnet": {
              "type": "string"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string"
            },
            "TrustedLaunch": {
              "type": "string"
            },
            "UserAssignedIdentityResourceId": {
              "type": "string"
            },
            "VirtualNetwork": {
              "type": "string"
            },
            "VirtualNetworkResourceGroup": {
              "type": "string"
            },
            "VirtualMachinePassword": {
              "type": "securestring"
            },
            "VirtualMachineUsername": {
              "type": "string"
            }
          },
          "resources": [
            {
              "condition": "[contains(parameters('ActiveDirectorySolution'), 'DomainServices')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('ManagementVirtualMachine_{0}', parameters('Timestamp'))]",
              "resourceGroup": "[parameters('ResourceGroupManagement')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "DiskEncryption": {
                    "value": "[parameters('DiskEncryption')]"
                  },
                  "DiskEncryptionSetResourceId": {
                    "value": "[parameters('DiskEncryptionSetResourceId')]"
                  },
                  "DiskSku": {
                    "value": "[parameters('DiskSku')]"
                  },
                  "DomainJoinPassword": {
                    "value": "[parameters('DomainJoinPassword')]"
                  },
                  "DomainJoinUserPrincipalName": {
                    "value": "[parameters('DomainJoinUserPrincipalName')]"
                  },
                  "DomainName": {
                    "value": "[parameters('DomainName')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "ManagementVmName": {
                    "value": "[parameters('ManagementVmName')]"
                  },
                  "NamingStandard": {
                    "value": "[parameters('NamingStandard')]"
                  },
                  "Subnet": {
                    "value": "[parameters('Subnet')]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "TrustedLaunch": {
                    "value": "[parameters('TrustedLaunch')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  },
                  "VirtualNetwork": {
                    "value": "[parameters('VirtualNetwork')]"
                  },
                  "VirtualNetworkResourceGroup": {
                    "value": "[parameters('VirtualNetworkResourceGroup')]"
                  },
                  "VirtualMachinePassword": {
                    "value": "[parameters('VirtualMachinePassword')]"
                  },
                  "VirtualMachineUsername": {
                    "value": "[parameters('VirtualMachineUsername')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "11610288145782948784"
                    }
                  },
                  "parameters": {
                    "DiskEncryption": {
                      "type": "bool"
                    },
                    "DiskEncryptionSetResourceId": {
                      "type": "string"
                    },
                    "DiskSku": {
                      "type": "string"
                    },
                    "DomainJoinPassword": {
                      "type": "securestring"
                    },
                    "DomainJoinUserPrincipalName": {
                      "type": "string"
                    },
                    "DomainName": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "ManagementVmName": {
                      "type": "string"
                    },
                    "NamingStandard": {
                      "type": "string"
                    },
                    "Subnet": {
                      "type": "string"
                    },
                    "Tags": {
                      "type": "object"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "TrustedLaunch": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    },
                    "VirtualNetwork": {
                      "type": "string"
                    },
                    "VirtualNetworkResourceGroup": {
                      "type": "string"
                    },
                    "VirtualMachinePassword": {
                      "type": "securestring"
                    },
                    "VirtualMachineUsername": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "NicName": "[format('nic-{0}-mgt', parameters('NamingStandard'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2020-05-01",
                      "name": "[variables('NicName')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[resourceId(parameters('VirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', parameters('VirtualNetwork'), parameters('Subnet'))]"
                              },
                              "primary": true,
                              "privateIPAddressVersion": "IPv4"
                            }
                          }
                        ],
                        "enableAcceleratedNetworking": false,
                        "enableIPForwarding": false
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2021-11-01",
                      "name": "[parameters('ManagementVmName')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "Standard_B2s"
                        },
                        "storageProfile": {
                          "imageReference": {
                            "publisher": "MicrosoftWindowsServer",
                            "offer": "WindowsServer",
                            "sku": "2019-datacenter-core-g2",
                            "version": "latest"
                          },
                          "osDisk": {
                            "deleteOption": "Delete",
                            "osType": "Windows",
                            "createOption": "FromImage",
                            "caching": "None",
                            "managedDisk": {
                              "diskEncryptionSet": "[if(parameters('DiskEncryption'), createObject('id', parameters('DiskEncryptionSetResourceId')), null())]",
                              "storageAccountType": "[parameters('DiskSku')]"
                            },
                            "name": "[format('disk-{0}-mgt', parameters('NamingStandard'))]"
                          },
                          "dataDisks": []
                        },
                        "osProfile": {
                          "computerName": "[parameters('ManagementVmName')]",
                          "adminUsername": "[parameters('VirtualMachineUsername')]",
                          "adminPassword": "[parameters('VirtualMachinePassword')]",
                          "windowsConfiguration": {
                            "provisionVMAgent": true,
                            "enableAutomaticUpdates": true
                          },
                          "secrets": [],
                          "allowExtensionOperations": true
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('NicName'))]",
                              "properties": {
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "securityProfile": {
                          "uefiSettings": "[if(equals(parameters('TrustedLaunch'), 'true'), createObject('secureBootEnabled', true(), 'vTpmEnabled', true()), null())]",
                          "securityType": "[if(equals(parameters('TrustedLaunch'), 'true'), 'TrustedLaunch', null())]",
                          "encryptionAtHost": "[parameters('DiskEncryption')]"
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": false
                          }
                        },
                        "licenseType": "Windows_Server"
                      },
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', variables('NicName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2019-07-01",
                      "name": "[format('{0}/{1}', parameters('ManagementVmName'), 'JsonADDomainExtension')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "publisher": "Microsoft.Compute",
                        "type": "JsonADDomainExtension",
                        "typeHandlerVersion": "1.3",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "Name": "[parameters('DomainName')]",
                          "User": "[parameters('DomainJoinUserPrincipalName')]",
                          "Restart": "true",
                          "Options": "3"
                        },
                        "protectedSettings": {
                          "Password": "[parameters('DomainJoinPassword')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('ManagementVmName'))]"
                      ]
                    }
                  ]
                }
              }
            },
            {
              "condition": "[and(equals(parameters('StorageSolution'), 'AzureNetAppFiles'), contains(parameters('ActiveDirectorySolution'), 'DomainServices'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('AzureNetAppFiles_{0}', parameters('Timestamp'))]",
              "resourceGroup": "[parameters('ResourceGroupStorage')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "ActiveDirectoryConnection": {
                    "value": "[parameters('ActiveDirectoryConnection')]"
                  },
                  "DelegatedSubnetId": {
                    "value": "[parameters('DelegatedSubnetId')]"
                  },
                  "DeploymentScriptNamePrefix": {
                    "value": "[parameters('DeploymentScriptNamePrefix')]"
                  },
                  "DnsServers": {
                    "value": "[parameters('DnsServers')]"
                  },
                  "DomainJoinPassword": {
                    "value": "[parameters('DomainJoinPassword')]"
                  },
                  "DomainJoinUserPrincipalName": {
                    "value": "[parameters('DomainJoinUserPrincipalName')]"
                  },
                  "DomainName": {
                    "value": "[parameters('DomainName')]"
                  },
                  "FileShares": {
                    "value": "[parameters('FileShares')]"
                  },
                  "FslogixSolution": {
                    "value": "[parameters('FslogixSolution')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "ManagementVmName": {
                    "value": "[parameters('ManagementVmName')]"
                  },
                  "NetAppAccountName": {
                    "value": "[parameters('NetAppAccountName')]"
                  },
                  "NetAppCapacityPoolName": {
                    "value": "[parameters('NetAppCapacityPoolName')]"
                  },
                  "OuPath": {
                    "value": "[parameters('OuPath')]"
                  },
                  "ResourceGroupManagement": {
                    "value": "[parameters('ResourceGroupManagement')]"
                  },
                  "SecurityPrincipalNames": {
                    "value": "[parameters('SecurityPrincipalNames')]"
                  },
                  "SmbServerLocation": {
                    "value": "[parameters('SmbServerLocation')]"
                  },
                  "StorageSku": {
                    "value": "[parameters('StorageSku')]"
                  },
                  "StorageSolution": {
                    "value": "[parameters('StorageSolution')]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "12894336958481445189"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "securestring"
                    },
                    "ActiveDirectoryConnection": {
                      "type": "string"
                    },
                    "DelegatedSubnetId": {
                      "type": "string"
                    },
                    "DeploymentScriptNamePrefix": {
                      "type": "string"
                    },
                    "DnsServers": {
                      "type": "string"
                    },
                    "DomainJoinPassword": {
                      "type": "securestring"
                    },
                    "DomainJoinUserPrincipalName": {
                      "type": "string"
                    },
                    "DomainName": {
                      "type": "string"
                    },
                    "FileShares": {
                      "type": "array"
                    },
                    "FslogixSolution": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "ManagementVmName": {
                      "type": "string"
                    },
                    "NetAppAccountName": {
                      "type": "string"
                    },
                    "NetAppCapacityPoolName": {
                      "type": "string"
                    },
                    "OuPath": {
                      "type": "string"
                    },
                    "ResourceGroupManagement": {
                      "type": "string"
                    },
                    "SecurityPrincipalNames": {
                      "type": "array"
                    },
                    "SmbServerLocation": {
                      "type": "string"
                    },
                    "StorageSku": {
                      "type": "string"
                    },
                    "StorageSolution": {
                      "type": "string"
                    },
                    "Tags": {
                      "type": "object"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.NetApp/netAppAccounts",
                      "apiVersion": "2021-06-01",
                      "name": "[parameters('NetAppAccountName')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "activeDirectories": "[if(equals(parameters('ActiveDirectoryConnection'), 'false'), null(), createArray(createObject('aesEncryption', false(), 'domain', parameters('DomainName'), 'dns', parameters('DnsServers'), 'organizationalUnit', parameters('OuPath'), 'password', parameters('DomainJoinPassword'), 'smbServerName', format('anf-{0}', parameters('SmbServerLocation')), 'username', split(parameters('DomainJoinUserPrincipalName'), '@')[0])))]",
                        "encryption": {
                          "keySource": "Microsoft.NetApp"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.NetApp/netAppAccounts/capacityPools",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}/{1}', parameters('NetAppAccountName'), parameters('NetAppCapacityPoolName'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "coolAccess": false,
                        "encryptionType": "Single",
                        "qosType": "Auto",
                        "serviceLevel": "[parameters('StorageSku')]",
                        "size": 4398046511104
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.NetApp/netAppAccounts', parameters('NetAppAccountName'))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "volumes",
                        "count": "[length(range(0, length(parameters('FileShares'))))]"
                      },
                      "type": "Microsoft.NetApp/netAppAccounts/capacityPools/volumes",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}/{1}/{2}', parameters('NetAppAccountName'), parameters('NetAppCapacityPoolName'), parameters('FileShares')[range(0, length(parameters('FileShares')))[copyIndex()]])]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "avsDataStore": "Disabled",
                        "coolAccess": false,
                        "creationToken": "[parameters('FileShares')[range(0, length(parameters('FileShares')))[copyIndex()]]]",
                        "defaultGroupQuotaInKiBs": 0,
                        "defaultUserQuotaInKiBs": 0,
                        "encryptionKeySource": "Microsoft.NetApp",
                        "isDefaultQuotaEnabled": false,
                        "kerberosEnabled": false,
                        "ldapEnabled": false,
                        "networkFeatures": "Basic",
                        "protocolTypes": [
                          "CIFS"
                        ],
                        "securityStyle": "ntfs",
                        "serviceLevel": "[parameters('StorageSku')]",
                        "smbEncryption": true,
                        "snapshotDirectoryVisible": true,
                        "subnetId": "[parameters('DelegatedSubnetId')]",
                        "usageThreshold": 107374182400
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.NetApp/netAppAccounts/capacityPools', parameters('NetAppAccountName'), parameters('NetAppCapacityPoolName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('FslogixNtfsPermissions_{0}', parameters('Timestamp'))]",
                      "resourceGroup": "[parameters('ResourceGroupManagement')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "_artifactsLocation": {
                            "value": "[parameters('_artifactsLocation')]"
                          },
                          "_artifactsLocationSasToken": {
                            "value": "[parameters('_artifactsLocationSasToken')]"
                          },
                          "CommandToExecute": {
                            "value": "[format('powershell -ExecutionPolicy Unrestricted -File Set-NtfsPermissions.ps1 -DomainJoinPassword \"{0}\" -DomainJoinUserPrincipalName {1} -FslogixSolution {2} -SecurityPrincipalNames \"{3}\" -SmbServerLocation {4} -StorageSolution {5}', parameters('DomainJoinPassword'), parameters('DomainJoinUserPrincipalName'), parameters('FslogixSolution'), parameters('SecurityPrincipalNames'), parameters('SmbServerLocation'), parameters('StorageSolution'))]"
                          },
                          "DeploymentScriptNamePrefix": {
                            "value": "[parameters('DeploymentScriptNamePrefix')]"
                          },
                          "Location": {
                            "value": "[parameters('Location')]"
                          },
                          "ManagementVmName": {
                            "value": "[parameters('ManagementVmName')]"
                          },
                          "Tags": {
                            "value": "[parameters('Tags')]"
                          },
                          "Timestamp": {
                            "value": "[parameters('Timestamp')]"
                          },
                          "UserAssignedIdentityResourceId": {
                            "value": "[parameters('UserAssignedIdentityResourceId')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.18.4.5664",
                              "templateHash": "3849467652108976255"
                            }
                          },
                          "parameters": {
                            "_artifactsLocation": {
                              "type": "string"
                            },
                            "_artifactsLocationSasToken": {
                              "type": "securestring"
                            },
                            "CommandToExecute": {
                              "type": "securestring"
                            },
                            "DeploymentScriptNamePrefix": {
                              "type": "string"
                            },
                            "Location": {
                              "type": "string"
                            },
                            "ManagementVmName": {
                              "type": "string"
                            },
                            "Tags": {
                              "type": "object"
                            },
                            "Timestamp": {
                              "type": "string"
                            },
                            "UserAssignedIdentityResourceId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2020-12-01",
                              "name": "[format('{0}/CustomScriptExtension', parameters('ManagementVmName'))]",
                              "location": "[parameters('Location')]",
                              "tags": "[parameters('Tags')]",
                              "properties": {
                                "publisher": "Microsoft.Compute",
                                "type": "CustomScriptExtension",
                                "typeHandlerVersion": "1.10",
                                "autoUpgradeMinorVersion": true,
                                "settings": {
                                  "fileUris": [
                                    "[format('{0}Set-NtfsPermissions.ps1{1}', parameters('_artifactsLocation'), parameters('_artifactsLocationSasToken'))]"
                                  ],
                                  "timestamp": "[parameters('Timestamp')]"
                                },
                                "protectedSettings": {
                                  "commandToExecute": "[parameters('CommandToExecute')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2022-09-01",
                              "name": "[format('DeploymentScript_FSLogix-CleanUp_{0}', parameters('Timestamp'))]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "Arguments": {
                                    "value": "[format('-VirtualMachineName {0} -ResourceGroupName {1}', parameters('ManagementVmName'), resourceGroup().name)]"
                                  },
                                  "Location": {
                                    "value": "[parameters('Location')]"
                                  },
                                  "Name": {
                                    "value": "[format('{0}fslogix', parameters('DeploymentScriptNamePrefix'))]"
                                  },
                                  "Script": {
                                    "value": "param([string]$ResourceGroupName,[string]$VirtualMachineName); Remove-AzVM -ResourceGroupName $ResourceGroupName -Name $VirtualMachineName -ForceDeletion $true -Force; $DeploymentScriptOutputs = @{}; $DeploymentScriptOutputs[\"virtualMachineName\"] = $VirtualMachineName"
                                  },
                                  "Timestamp": {
                                    "value": "[parameters('Timestamp')]"
                                  },
                                  "UserAssignedIdentityResourceId": {
                                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.18.4.5664",
                                      "templateHash": "1338006163064225507"
                                    }
                                  },
                                  "parameters": {
                                    "Arguments": {
                                      "type": "string"
                                    },
                                    "Location": {
                                      "type": "string"
                                    },
                                    "Name": {
                                      "type": "string"
                                    },
                                    "Script": {
                                      "type": "string"
                                    },
                                    "Timestamp": {
                                      "type": "string"
                                    },
                                    "UserAssignedIdentityResourceId": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Resources/deploymentScripts",
                                      "apiVersion": "2020-10-01",
                                      "name": "[parameters('Name')]",
                                      "identity": {
                                        "type": "UserAssigned",
                                        "userAssignedIdentities": {
                                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                                        }
                                      },
                                      "location": "[parameters('Location')]",
                                      "kind": "AzurePowerShell",
                                      "tags": {},
                                      "properties": {
                                        "arguments": "[parameters('Arguments')]",
                                        "azPowerShellVersion": "9.4",
                                        "cleanupPreference": "Always",
                                        "forceUpdateTag": "[parameters('Timestamp')]",
                                        "retentionInterval": "PT2H",
                                        "scriptContent": "[parameters('Script')]",
                                        "timeout": "PT30M"
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "properties": {
                                      "type": "object",
                                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/CustomScriptExtension', parameters('ManagementVmName')), '/')[0], split(format('{0}/CustomScriptExtension', parameters('ManagementVmName')), '/')[1])]"
                              ]
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "volumes"
                      ]
                    }
                  ],
                  "outputs": {
                    "fileShares": {
                      "type": "array",
                      "value": "[if(contains(parameters('FslogixSolution'), 'Office'), createArray(reference(resourceId('Microsoft.NetApp/netAppAccounts/capacityPools/volumes', parameters('NetAppAccountName'), parameters('NetAppCapacityPoolName'), parameters('FileShares')[range(0, length(parameters('FileShares')))[0]]), '2021-06-01').mountTargets[0].smbServerFqdn, reference(resourceId('Microsoft.NetApp/netAppAccounts/capacityPools/volumes', parameters('NetAppAccountName'), parameters('NetAppCapacityPoolName'), parameters('FileShares')[range(0, length(parameters('FileShares')))[1]]), '2021-06-01').mountTargets[0].smbServerFqdn), createArray(reference(resourceId('Microsoft.NetApp/netAppAccounts/capacityPools/volumes', parameters('NetAppAccountName'), parameters('NetAppCapacityPoolName'), parameters('FileShares')[range(0, length(parameters('FileShares')))[0]]), '2021-06-01').mountTargets[0].smbServerFqdn))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('ManagementVirtualMachine_{0}', parameters('Timestamp')))]"
              ]
            },
            {
              "condition": "[and(equals(parameters('StorageSolution'), 'AzureStorageAccount'), contains(parameters('ActiveDirectorySolution'), 'DomainServices'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('AzureFiles_{0}', parameters('Timestamp'))]",
              "resourceGroup": "[parameters('ResourceGroupStorage')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "ActiveDirectorySolution": {
                    "value": "[parameters('ActiveDirectorySolution')]"
                  },
                  "Availability": {
                    "value": "[parameters('Availability')]"
                  },
                  "AzureFilesPrivateDnsZoneResourceId": {
                    "value": "[parameters('AzureFilesPrivateDnsZoneResourceId')]"
                  },
                  "ClientId": {
                    "value": "[parameters('ClientId')]"
                  },
                  "DeploymentScriptNamePrefix": {
                    "value": "[parameters('DeploymentScriptNamePrefix')]"
                  },
                  "DomainJoinPassword": {
                    "value": "[parameters('DomainJoinPassword')]"
                  },
                  "DomainJoinUserPrincipalName": {
                    "value": "[parameters('DomainJoinUserPrincipalName')]"
                  },
                  "FileShares": {
                    "value": "[parameters('FileShares')]"
                  },
                  "FslogixShareSizeInGB": {
                    "value": "[parameters('FslogixShareSizeInGB')]"
                  },
                  "FslogixSolution": {
                    "value": "[parameters('FslogixSolution')]"
                  },
                  "FslogixStorage": {
                    "value": "[parameters('FslogixStorage')]"
                  },
                  "KerberosEncryption": {
                    "value": "[parameters('KerberosEncryption')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "ManagementVmName": {
                    "value": "[parameters('ManagementVmName')]"
                  },
                  "Netbios": {
                    "value": "[parameters('Netbios')]"
                  },
                  "OuPath": {
                    "value": "[parameters('OuPath')]"
                  },
                  "PrivateEndpoint": {
                    "value": "[parameters('PrivateEndpoint')]"
                  },
                  "ResourceGroupManagement": {
                    "value": "[parameters('ResourceGroupManagement')]"
                  },
                  "ResourceGroupStorage": {
                    "value": "[parameters('ResourceGroupStorage')]"
                  },
                  "SecurityPrincipalIds": {
                    "value": "[parameters('SecurityPrincipalIds')]"
                  },
                  "SecurityPrincipalNames": {
                    "value": "[parameters('SecurityPrincipalNames')]"
                  },
                  "StorageAccountPrefix": {
                    "value": "[parameters('StorageAccountPrefix')]"
                  },
                  "StorageCount": {
                    "value": "[parameters('StorageCount')]"
                  },
                  "StorageIndex": {
                    "value": "[parameters('StorageIndex')]"
                  },
                  "StorageSku": {
                    "value": "[parameters('StorageSku')]"
                  },
                  "StorageSolution": {
                    "value": "[parameters('StorageSolution')]"
                  },
                  "Subnet": {
                    "value": "[parameters('Subnet')]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "UserAssignedIdentityResourceId": {
                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                  },
                  "VirtualNetwork": {
                    "value": "[parameters('VirtualNetwork')]"
                  },
                  "VirtualNetworkResourceGroup": {
                    "value": "[parameters('VirtualNetworkResourceGroup')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "14716555459239656410"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "securestring"
                    },
                    "Availability": {
                      "type": "string"
                    },
                    "AzureFilesPrivateDnsZoneResourceId": {
                      "type": "string"
                    },
                    "ClientId": {
                      "type": "string"
                    },
                    "DeploymentScriptNamePrefix": {
                      "type": "string"
                    },
                    "DomainJoinPassword": {
                      "type": "securestring"
                    },
                    "DomainJoinUserPrincipalName": {
                      "type": "string"
                    },
                    "ActiveDirectorySolution": {
                      "type": "string"
                    },
                    "FileShares": {
                      "type": "array"
                    },
                    "FslogixShareSizeInGB": {
                      "type": "int"
                    },
                    "FslogixSolution": {
                      "type": "string"
                    },
                    "FslogixStorage": {
                      "type": "string"
                    },
                    "KerberosEncryption": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "ManagementVmName": {
                      "type": "string"
                    },
                    "Netbios": {
                      "type": "string"
                    },
                    "OuPath": {
                      "type": "string"
                    },
                    "PrivateEndpoint": {
                      "type": "bool"
                    },
                    "ResourceGroupManagement": {
                      "type": "string"
                    },
                    "ResourceGroupStorage": {
                      "type": "string"
                    },
                    "SecurityPrincipalIds": {
                      "type": "array"
                    },
                    "SecurityPrincipalNames": {
                      "type": "array"
                    },
                    "StorageAccountPrefix": {
                      "type": "string"
                    },
                    "StorageCount": {
                      "type": "int"
                    },
                    "StorageIndex": {
                      "type": "int"
                    },
                    "StorageSku": {
                      "type": "string"
                    },
                    "StorageSolution": {
                      "type": "string"
                    },
                    "Subnet": {
                      "type": "string"
                    },
                    "Tags": {
                      "type": "object"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "UserAssignedIdentityResourceId": {
                      "type": "string"
                    },
                    "VirtualNetwork": {
                      "type": "string"
                    },
                    "VirtualNetworkResourceGroup": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "Endpoint": "[split(parameters('FslogixStorage'), ' ')[2]]",
                    "RoleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '0c867c2a-1d8c-454a-a3db-ab2ea1bdc8bb')]",
                    "SmbMultiChannel": {
                      "multichannel": {
                        "enabled": true
                      }
                    },
                    "SmbSettings": {
                      "versions": "SMB3.0;SMB3.1.1;",
                      "authenticationMethods": "NTLMv2;Kerberos;",
                      "kerberosTicketEncryption": "[if(equals(parameters('KerberosEncryption'), 'RC4'), 'RC4-HMAC;', 'AES-256;')]",
                      "channelEncryption": "AES-128-CCM;AES-128-GCM;AES-256-GCM;"
                    },
                    "StorageRedundancy": "[if(equals(parameters('Availability'), 'AvailabilityZones'), '_ZRS', '_LRS')]",
                    "SubnetId": "[resourceId(parameters('VirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', parameters('VirtualNetwork'), parameters('Subnet'))]",
                    "VirtualNetworkRules": {
                      "PrivateEndpoint": [],
                      "PublicEndpoint": [],
                      "ServiceEndpoint": [
                        {
                          "id": "[variables('SubnetId')]",
                          "action": "Allow"
                        }
                      ]
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "storageAccounts",
                        "count": "[length(range(0, parameters('StorageCount')))]"
                      },
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[copyIndex()], parameters('StorageIndex')))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "sku": {
                        "name": "[format('{0}{1}', parameters('StorageSku'), variables('StorageRedundancy'))]"
                      },
                      "kind": "[if(equals(parameters('StorageSku'), 'Standard'), 'StorageV2', 'FileStorage')]",
                      "properties": {
                        "minimumTlsVersion": "TLS1_2",
                        "networkAcls": {
                          "bypass": "AzureServices",
                          "virtualNetworkRules": "[variables('VirtualNetworkRules')[variables('Endpoint')]]",
                          "ipRules": [],
                          "defaultAction": "[if(equals(variables('Endpoint'), 'PublicEndpoint'), 'Allow', 'Deny')]"
                        },
                        "publicNetworkAccess": "[if(equals(variables('Endpoint'), 'PrivateEndpoint'), 'Disabled', 'Enabled')]",
                        "supportsHttpsTrafficOnly": true,
                        "encryption": {
                          "services": {
                            "file": {
                              "keyType": "Account",
                              "enabled": true
                            }
                          },
                          "keySource": "Microsoft.Storage"
                        },
                        "azureFilesIdentityBasedAuthentication": {
                          "directoryServiceOptions": "[if(equals(parameters('ActiveDirectorySolution'), 'AzureActiveDirectoryDomainServices'), 'AADDS', 'None')]"
                        },
                        "largeFileSharesState": "[if(equals(parameters('StorageSku'), 'Standard'), 'Enabled', null())]"
                      }
                    },
                    {
                      "copy": {
                        "name": "roleAssignment",
                        "count": "[length(range(0, parameters('StorageCount')))]"
                      },
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))))]",
                      "name": "[guid(parameters('SecurityPrincipalIds')[range(0, parameters('StorageCount'))[copyIndex()]], variables('RoleDefinitionId'), resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex')))))]",
                      "properties": {
                        "roleDefinitionId": "[variables('RoleDefinitionId')]",
                        "principalId": "[parameters('SecurityPrincipalIds')[range(0, parameters('StorageCount'))[copyIndex()]]]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))))]",
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "fileServices",
                        "count": "[length(range(0, parameters('StorageCount')))]"
                      },
                      "type": "Microsoft.Storage/storageAccounts/fileServices",
                      "apiVersion": "2022-09-01",
                      "name": "[format('{0}/{1}', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))), 'default')]",
                      "properties": {
                        "protocolSettings": {
                          "smb": "[if(equals(parameters('StorageSku'), 'Standard'), variables('SmbSettings'), union(variables('SmbSettings'), variables('SmbMultiChannel')))]"
                        },
                        "shareDeleteRetentionPolicy": {
                          "enabled": false
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "privateEndpoints",
                        "count": "[length(range(0, parameters('StorageCount')))]"
                      },
                      "condition": "[parameters('PrivateEndpoint')]",
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2020-05-01",
                      "name": "[format('pe-{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[copyIndex()], parameters('StorageIndex')))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "subnet": {
                          "id": "[variables('SubnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[format('pe-{0}_{1}', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))), guid(format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex')))))]",
                            "properties": {
                              "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))))]",
                              "groupIds": [
                                "file"
                              ]
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))))]",
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))))]",
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "privateDnsZoneGroups",
                        "count": "[length(range(0, parameters('StorageCount')))]"
                      },
                      "condition": "[parameters('PrivateEndpoint')]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-08-01",
                      "name": "[format('{0}/{1}', format('pe-{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))), format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[copyIndex()], parameters('StorageIndex'))))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "privateDnsZoneId": "[parameters('AzureFilesPrivateDnsZoneResourceId')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', format('pe-{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))))]",
                        "storageAccounts"
                      ]
                    },
                    {
                      "copy": {
                        "name": "shares",
                        "count": "[length(range(0, parameters('StorageCount')))]"
                      },
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('FileShares_{0}_{1}', range(0, parameters('StorageCount'))[copyIndex()], parameters('Timestamp'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "FileShares": {
                            "value": "[parameters('FileShares')]"
                          },
                          "FslogixShareSizeInGB": {
                            "value": "[parameters('FslogixShareSizeInGB')]"
                          },
                          "StorageAccountName": {
                            "value": "[format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex')))]"
                          },
                          "StorageSku": {
                            "value": "[parameters('StorageSku')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.18.4.5664",
                              "templateHash": "12871909299430194317"
                            }
                          },
                          "parameters": {
                            "FileShares": {
                              "type": "array"
                            },
                            "FslogixShareSizeInGB": {
                              "type": "int"
                            },
                            "StorageAccountName": {
                              "type": "string"
                            },
                            "StorageSku": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "copy": {
                                "name": "shares",
                                "count": "[length(range(0, length(parameters('FileShares'))))]"
                              },
                              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
                              "apiVersion": "2022-09-01",
                              "name": "[format('{0}/default/{1}', parameters('StorageAccountName'), parameters('FileShares')[range(0, length(parameters('FileShares')))[copyIndex()]])]",
                              "properties": {
                                "accessTier": "[if(equals(parameters('StorageSku'), 'Premium'), 'Premium', 'TransactionOptimized')]",
                                "shareQuota": "[parameters('FslogixShareSizeInGB')]",
                                "enabledProtocols": "SMB"
                              }
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "roleAssignment",
                        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))))]"
                      ]
                    },
                    {
                      "condition": "[contains(parameters('ActiveDirectorySolution'), 'DomainServices')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('FslogixNtfsPermissions_{0}', parameters('Timestamp'))]",
                      "resourceGroup": "[parameters('ResourceGroupManagement')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "_artifactsLocation": {
                            "value": "[parameters('_artifactsLocation')]"
                          },
                          "_artifactsLocationSasToken": {
                            "value": "[parameters('_artifactsLocationSasToken')]"
                          },
                          "CommandToExecute": {
                            "value": "[format('powershell -ExecutionPolicy Unrestricted -File Set-NtfsPermissions.ps1 -ClientId {0} -DomainJoinPassword \"{1}\" -DomainJoinUserPrincipalName {2} -ActiveDirectorySolution {3} -Environment {4} -FslogixSolution {5} -KerberosEncryptionType {6} -Netbios {7} -OuPath \"{8}\" -SecurityPrincipalNames \"{9}\" -StorageAccountPrefix {10} -StorageAccountResourceGroupName {11} -StorageCount {12} -StorageIndex {13} -StorageSolution {14} -StorageSuffix {15} -SubscriptionId {16} -TenantId {17}', parameters('ClientId'), parameters('DomainJoinPassword'), parameters('DomainJoinUserPrincipalName'), parameters('ActiveDirectorySolution'), environment().name, parameters('FslogixSolution'), parameters('KerberosEncryption'), parameters('Netbios'), parameters('OuPath'), parameters('SecurityPrincipalNames'), parameters('StorageAccountPrefix'), parameters('ResourceGroupStorage'), parameters('StorageCount'), parameters('StorageIndex'), parameters('StorageSolution'), environment().suffixes.storage, subscription().subscriptionId, subscription().tenantId)]"
                          },
                          "DeploymentScriptNamePrefix": {
                            "value": "[parameters('DeploymentScriptNamePrefix')]"
                          },
                          "Location": {
                            "value": "[parameters('Location')]"
                          },
                          "ManagementVmName": {
                            "value": "[parameters('ManagementVmName')]"
                          },
                          "Tags": {
                            "value": "[parameters('Tags')]"
                          },
                          "Timestamp": {
                            "value": "[parameters('Timestamp')]"
                          },
                          "UserAssignedIdentityResourceId": {
                            "value": "[parameters('UserAssignedIdentityResourceId')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.18.4.5664",
                              "templateHash": "3849467652108976255"
                            }
                          },
                          "parameters": {
                            "_artifactsLocation": {
                              "type": "string"
                            },
                            "_artifactsLocationSasToken": {
                              "type": "securestring"
                            },
                            "CommandToExecute": {
                              "type": "securestring"
                            },
                            "DeploymentScriptNamePrefix": {
                              "type": "string"
                            },
                            "Location": {
                              "type": "string"
                            },
                            "ManagementVmName": {
                              "type": "string"
                            },
                            "Tags": {
                              "type": "object"
                            },
                            "Timestamp": {
                              "type": "string"
                            },
                            "UserAssignedIdentityResourceId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Compute/virtualMachines/extensions",
                              "apiVersion": "2020-12-01",
                              "name": "[format('{0}/CustomScriptExtension', parameters('ManagementVmName'))]",
                              "location": "[parameters('Location')]",
                              "tags": "[parameters('Tags')]",
                              "properties": {
                                "publisher": "Microsoft.Compute",
                                "type": "CustomScriptExtension",
                                "typeHandlerVersion": "1.10",
                                "autoUpgradeMinorVersion": true,
                                "settings": {
                                  "fileUris": [
                                    "[format('{0}Set-NtfsPermissions.ps1{1}', parameters('_artifactsLocation'), parameters('_artifactsLocationSasToken'))]"
                                  ],
                                  "timestamp": "[parameters('Timestamp')]"
                                },
                                "protectedSettings": {
                                  "commandToExecute": "[parameters('CommandToExecute')]"
                                }
                              }
                            },
                            {
                              "type": "Microsoft.Resources/deployments",
                              "apiVersion": "2022-09-01",
                              "name": "[format('DeploymentScript_FSLogix-CleanUp_{0}', parameters('Timestamp'))]",
                              "properties": {
                                "expressionEvaluationOptions": {
                                  "scope": "inner"
                                },
                                "mode": "Incremental",
                                "parameters": {
                                  "Arguments": {
                                    "value": "[format('-VirtualMachineName {0} -ResourceGroupName {1}', parameters('ManagementVmName'), resourceGroup().name)]"
                                  },
                                  "Location": {
                                    "value": "[parameters('Location')]"
                                  },
                                  "Name": {
                                    "value": "[format('{0}fslogix', parameters('DeploymentScriptNamePrefix'))]"
                                  },
                                  "Script": {
                                    "value": "param([string]$ResourceGroupName,[string]$VirtualMachineName); Remove-AzVM -ResourceGroupName $ResourceGroupName -Name $VirtualMachineName -ForceDeletion $true -Force; $DeploymentScriptOutputs = @{}; $DeploymentScriptOutputs[\"virtualMachineName\"] = $VirtualMachineName"
                                  },
                                  "Timestamp": {
                                    "value": "[parameters('Timestamp')]"
                                  },
                                  "UserAssignedIdentityResourceId": {
                                    "value": "[parameters('UserAssignedIdentityResourceId')]"
                                  }
                                },
                                "template": {
                                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                  "contentVersion": "1.0.0.0",
                                  "metadata": {
                                    "_generator": {
                                      "name": "bicep",
                                      "version": "0.18.4.5664",
                                      "templateHash": "1338006163064225507"
                                    }
                                  },
                                  "parameters": {
                                    "Arguments": {
                                      "type": "string"
                                    },
                                    "Location": {
                                      "type": "string"
                                    },
                                    "Name": {
                                      "type": "string"
                                    },
                                    "Script": {
                                      "type": "string"
                                    },
                                    "Timestamp": {
                                      "type": "string"
                                    },
                                    "UserAssignedIdentityResourceId": {
                                      "type": "string"
                                    }
                                  },
                                  "resources": [
                                    {
                                      "type": "Microsoft.Resources/deploymentScripts",
                                      "apiVersion": "2020-10-01",
                                      "name": "[parameters('Name')]",
                                      "identity": {
                                        "type": "UserAssigned",
                                        "userAssignedIdentities": {
                                          "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                                        }
                                      },
                                      "location": "[parameters('Location')]",
                                      "kind": "AzurePowerShell",
                                      "tags": {},
                                      "properties": {
                                        "arguments": "[parameters('Arguments')]",
                                        "azPowerShellVersion": "9.4",
                                        "cleanupPreference": "Always",
                                        "forceUpdateTag": "[parameters('Timestamp')]",
                                        "retentionInterval": "PT2H",
                                        "scriptContent": "[parameters('Script')]",
                                        "timeout": "PT30M"
                                      }
                                    }
                                  ],
                                  "outputs": {
                                    "properties": {
                                      "type": "object",
                                      "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                                    }
                                  }
                                }
                              },
                              "dependsOn": [
                                "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/CustomScriptExtension', parameters('ManagementVmName')), '/')[0], split(format('{0}/CustomScriptExtension', parameters('ManagementVmName')), '/')[1])]"
                              ]
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "privateDnsZoneGroups",
                        "privateEndpoints",
                        "shares"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('ManagementVirtualMachine_{0}', parameters('Timestamp')))]"
              ]
            }
          ],
          "outputs": {
            "netAppShares": {
              "type": "array",
              "value": "[if(equals(parameters('StorageSolution'), 'AzureNetAppFiles'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroupStorage')), 'Microsoft.Resources/deployments', format('AzureNetAppFiles_{0}', parameters('Timestamp'))), '2022-09-01').outputs.fileShares.value, createArray('None'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('DiskEncryption_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('UserAssignedIdentity_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Validations_{0}', parameters('Timestamp')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('Sentinel_{0}', parameters('Timestamp'))]",
      "subscriptionId": "[parameters('SentinelLogAnalyticsWorkspaceSubscriptionId')]",
      "resourceGroup": "[variables('SentinelResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "Sentinel": {
            "value": "[variables('Sentinel')]"
          },
          "SentinelLogAnalyticsWorkspaceName": {
            "value": "[parameters('SentinelLogAnalyticsWorkspaceName')]"
          },
          "SentinelLogAnalyticsWorkspaceResourceGroupName": {
            "value": "[parameters('SentinelLogAnalyticsWorkspaceResourceGroupName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "6328279639183147430"
            }
          },
          "parameters": {
            "Sentinel": {
              "type": "bool"
            },
            "SentinelLogAnalyticsWorkspaceName": {
              "type": "string"
            },
            "SentinelLogAnalyticsWorkspaceResourceGroupName": {
              "type": "string"
            }
          },
          "resources": [],
          "outputs": {
            "sentinelWorkspaceId": {
              "type": "string",
              "value": "[if(parameters('Sentinel'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('SentinelLogAnalyticsWorkspaceResourceGroupName')), 'Microsoft.OperationalInsights/workspaces', parameters('SentinelLogAnalyticsWorkspaceName')), '2021-06-01').customerId, 'NotApplicable')]"
            },
            "sentinelWorkspaceResourceId": {
              "type": "string",
              "value": "[if(parameters('Sentinel'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('SentinelLogAnalyticsWorkspaceResourceGroupName')), 'Microsoft.OperationalInsights/workspaces', parameters('SentinelLogAnalyticsWorkspaceName')), 'NotApplicable')]"
            }
          }
        }
      },
      "dependsOn": [
        "resourceGroups"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('SessionHosts_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroupHosts')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "AcceleratedNetworking": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Validations_{0}', parameters('Timestamp'))), '2022-09-01').outputs.acceleratedNetworking.value]"
          },
          "Availability": {
            "value": "[parameters('Availability')]"
          },
          "AvailabilityZones": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Validations_{0}', parameters('Timestamp'))), '2022-09-01').outputs.availabilityZones.value]"
          },
          "AvailabilitySetCount": {
            "value": "[variables('AvailabilitySetCount')]"
          },
          "AvailabilitySetPrefix": {
            "value": "[variables('AvailabilitySetPrefix')]"
          },
          "AvailabilitySetIndex": {
            "value": "[variables('BeginAvSetRange')]"
          },
          "DeploymentScriptNamePrefix": {
            "value": "[variables('DeploymentScriptNamePrefix')]"
          },
          "DiskEncryption": {
            "value": "[parameters('DiskEncryption')]"
          },
          "DiskEncryptionSetResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('DiskEncryption_{0}', parameters('Timestamp'))), '2022-09-01').outputs.diskEncryptionSetResourceId.value]"
          },
          "DiskName": {
            "value": "[variables('DiskName')]"
          },
          "DiskSku": {
            "value": "[parameters('DiskSku')]"
          },
          "DivisionRemainderValue": {
            "value": "[variables('DivisionRemainderValue')]"
          },
          "DomainJoinPassword": {
            "value": "[parameters('DomainJoinPassword')]"
          },
          "DomainJoinUserPrincipalName": {
            "value": "[parameters('DomainJoinUserPrincipalName')]"
          },
          "DomainName": {
            "value": "[parameters('DomainName')]"
          },
          "ActiveDirectorySolution": {
            "value": "[parameters('ActiveDirectorySolution')]"
          },
          "DrainMode": {
            "value": "[parameters('DrainMode')]"
          },
          "Fslogix": {
            "value": "[variables('Fslogix')]"
          },
          "FslogixSolution": {
            "value": "[parameters('FslogixSolution')]"
          },
          "HostPoolName": {
            "value": "[variables('HostPoolName')]"
          },
          "HostPoolType": {
            "value": "[parameters('HostPoolType')]"
          },
          "ImageOffer": {
            "value": "[parameters('ImageOffer')]"
          },
          "ImagePublisher": {
            "value": "[parameters('ImagePublisher')]"
          },
          "ImageSku": {
            "value": "[parameters('ImageSku')]"
          },
          "ImageVersion": {
            "value": "[parameters('ImageVersion')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "LogAnalyticsWorkspaceName": {
            "value": "[variables('LogAnalyticsWorkspaceName')]"
          },
          "ManagedIdentityResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('UserAssignedIdentity_{0}', parameters('Timestamp'))), '2022-09-01').outputs.id.value]"
          },
          "MaxResourcesPerTemplateDeployment": {
            "value": "[variables('MaxResourcesPerTemplateDeployment')]"
          },
          "Monitoring": {
            "value": "[parameters('Monitoring')]"
          },
          "NamingStandard": {
            "value": "[variables('NamingStandard')]"
          },
          "NetAppFileShares": "[if(variables('Fslogix'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('FSLogix_{0}', parameters('Timestamp'))), '2022-09-01').outputs.netAppShares.value), createObject('value', createArray('None')))]",
          "OuPath": {
            "value": "[parameters('OuPath')]"
          },
          "PooledHostPool": {
            "value": "[variables('PooledHostPool')]"
          },
          "ResourceGroupHosts": {
            "value": "[variables('ResourceGroupHosts')]"
          },
          "ResourceGroupManagement": {
            "value": "[variables('ResourceGroupManagement')]"
          },
          "ScreenCaptureProtection": {
            "value": "[parameters('ScreenCaptureProtection')]"
          },
          "SecurityPrincipalObjectIds": {
            "value": "[parameters('SecurityPrincipalObjectIds')]"
          },
          "Sentinel": {
            "value": "[variables('Sentinel')]"
          },
          "SentinelWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('SentinelLogAnalyticsWorkspaceSubscriptionId'), variables('SentinelResourceGroup')), 'Microsoft.Resources/deployments', format('Sentinel_{0}', parameters('Timestamp'))), '2022-09-01').outputs.sentinelWorkspaceId.value]"
          },
          "SentinelWorkspaceResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('SentinelLogAnalyticsWorkspaceSubscriptionId'), variables('SentinelResourceGroup')), 'Microsoft.Resources/deployments', format('Sentinel_{0}', parameters('Timestamp'))), '2022-09-01').outputs.sentinelWorkspaceResourceId.value]"
          },
          "SessionHostBatchCount": {
            "value": "[variables('SessionHostBatchCount')]"
          },
          "SessionHostIndex": {
            "value": "[parameters('SessionHostIndex')]"
          },
          "StorageAccountPrefix": {
            "value": "[variables('StorageAccountPrefix')]"
          },
          "StorageCount": {
            "value": "[parameters('StorageCount')]"
          },
          "StorageIndex": {
            "value": "[parameters('StorageIndex')]"
          },
          "StorageSolution": {
            "value": "[variables('StorageSolution')]"
          },
          "StorageSuffix": {
            "value": "[variables('StorageSuffix')]"
          },
          "Subnet": {
            "value": "[split(parameters('SubnetResourceId'), '/')[10]]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "TrustedLaunch": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Validations_{0}', parameters('Timestamp'))), '2022-09-01').outputs.trustedLaunch.value]"
          },
          "VirtualNetwork": {
            "value": "[split(parameters('SubnetResourceId'), '/')[8]]"
          },
          "VirtualNetworkResourceGroup": {
            "value": "[split(parameters('SubnetResourceId'), '/')[4]]"
          },
          "VmName": {
            "value": "[variables('VmName')]"
          },
          "VirtualMachinePassword": {
            "value": "[parameters('VirtualMachinePassword')]"
          },
          "VirtualMachineSize": {
            "value": "[parameters('VirtualMachineSize')]"
          },
          "VirtualMachineUsername": {
            "value": "[parameters('VirtualMachineUsername')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "12870828976392524012"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string"
            },
            "_artifactsLocationSasToken": {
              "type": "securestring"
            },
            "AcceleratedNetworking": {
              "type": "string"
            },
            "Availability": {
              "type": "string"
            },
            "AvailabilitySetCount": {
              "type": "int"
            },
            "AvailabilitySetIndex": {
              "type": "int"
            },
            "AvailabilitySetPrefix": {
              "type": "string"
            },
            "AvailabilityZones": {
              "type": "array"
            },
            "DeploymentScriptNamePrefix": {
              "type": "string"
            },
            "DiskEncryption": {
              "type": "bool"
            },
            "DiskEncryptionSetResourceId": {
              "type": "string"
            },
            "DiskName": {
              "type": "string"
            },
            "DiskSku": {
              "type": "string"
            },
            "DivisionRemainderValue": {
              "type": "int"
            },
            "DomainJoinPassword": {
              "type": "securestring"
            },
            "DomainJoinUserPrincipalName": {
              "type": "string"
            },
            "DomainName": {
              "type": "string"
            },
            "ActiveDirectorySolution": {
              "type": "string"
            },
            "DrainMode": {
              "type": "bool"
            },
            "FslogixSolution": {
              "type": "string"
            },
            "Fslogix": {
              "type": "bool"
            },
            "HostPoolName": {
              "type": "string"
            },
            "HostPoolType": {
              "type": "string"
            },
            "ImageOffer": {
              "type": "string"
            },
            "ImagePublisher": {
              "type": "string"
            },
            "ImageSku": {
              "type": "string"
            },
            "ImageVersion": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "LogAnalyticsWorkspaceName": {
              "type": "string"
            },
            "ManagedIdentityResourceId": {
              "type": "string"
            },
            "MaxResourcesPerTemplateDeployment": {
              "type": "int"
            },
            "Monitoring": {
              "type": "bool"
            },
            "NamingStandard": {
              "type": "string"
            },
            "NetAppFileShares": {
              "type": "array"
            },
            "OuPath": {
              "type": "string"
            },
            "PooledHostPool": {
              "type": "bool"
            },
            "ResourceGroupHosts": {
              "type": "string"
            },
            "ResourceGroupManagement": {
              "type": "string"
            },
            "ScreenCaptureProtection": {
              "type": "bool"
            },
            "SecurityPrincipalObjectIds": {
              "type": "array"
            },
            "Sentinel": {
              "type": "bool"
            },
            "SentinelWorkspaceId": {
              "type": "string"
            },
            "SentinelWorkspaceResourceId": {
              "type": "string"
            },
            "SessionHostBatchCount": {
              "type": "int"
            },
            "SessionHostIndex": {
              "type": "int"
            },
            "StorageAccountPrefix": {
              "type": "string"
            },
            "StorageCount": {
              "type": "int"
            },
            "StorageIndex": {
              "type": "int"
            },
            "StorageSolution": {
              "type": "string"
            },
            "StorageSuffix": {
              "type": "string"
            },
            "Subnet": {
              "type": "string"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string"
            },
            "TrustedLaunch": {
              "type": "string"
            },
            "VirtualNetwork": {
              "type": "string"
            },
            "VirtualNetworkResourceGroup": {
              "type": "string"
            },
            "VmName": {
              "type": "string"
            },
            "VirtualMachinePassword": {
              "type": "securestring"
            },
            "VirtualMachineSize": {
              "type": "string"
            },
            "VirtualMachineUsername": {
              "type": "string"
            }
          },
          "variables": {
            "VirtualMachineUserLoginRoleDefinitionResourceId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'fb879df8-f326-4884-b1cf-06f3ad86be52')]"
          },
          "resources": [
            {
              "copy": {
                "name": "availabilitySets",
                "count": "[length(range(0, parameters('AvailabilitySetCount')))]"
              },
              "condition": "[and(parameters('PooledHostPool'), equals(parameters('Availability'), 'AvailabilitySet'))]",
              "type": "Microsoft.Compute/availabilitySets",
              "apiVersion": "2019-07-01",
              "name": "[format('{0}{1}', parameters('AvailabilitySetPrefix'), padLeft(add(range(0, parameters('AvailabilitySetCount'))[copyIndex()], parameters('AvailabilitySetIndex')), 2, '0'))]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "sku": {
                "name": "Aligned"
              },
              "properties": {
                "platformUpdateDomainCount": 5,
                "platformFaultDomainCount": 2
              }
            },
            {
              "copy": {
                "name": "roleAssignments",
                "count": "[length(range(0, length(parameters('SecurityPrincipalObjectIds'))))]"
              },
              "condition": "[not(contains(parameters('ActiveDirectorySolution'), 'DomainServices'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('RoleAssignments_{0}_{1}', range(0, length(parameters('SecurityPrincipalObjectIds')))[copyIndex()], parameters('Timestamp'))]",
              "resourceGroup": "[parameters('ResourceGroupHosts')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrincipalId": {
                    "value": "[parameters('SecurityPrincipalObjectIds')[range(0, length(parameters('SecurityPrincipalObjectIds')))[copyIndex()]]]"
                  },
                  "RoleDefinitionId": {
                    "value": "[variables('VirtualMachineUserLoginRoleDefinitionResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "8096479380248432665"
                    }
                  },
                  "parameters": {
                    "PrincipalId": {
                      "type": "string"
                    },
                    "RoleDefinitionId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "name": "[guid(parameters('PrincipalId'), parameters('RoleDefinitionId'), resourceGroup().id)]",
                      "properties": {
                        "roleDefinitionId": "[parameters('RoleDefinitionId')]",
                        "principalId": "[parameters('PrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ]
                }
              }
            },
            {
              "copy": {
                "name": "virtualMachines",
                "count": "[length(range(1, parameters('SessionHostBatchCount')))]",
                "mode": "serial",
                "batchSize": 1
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('VirtualMachines_{0}_{1}', sub(range(1, parameters('SessionHostBatchCount'))[copyIndex()], 1), parameters('Timestamp'))]",
              "resourceGroup": "[parameters('ResourceGroupHosts')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "_artifactsLocation": {
                    "value": "[parameters('_artifactsLocation')]"
                  },
                  "_artifactsLocationSasToken": {
                    "value": "[parameters('_artifactsLocationSasToken')]"
                  },
                  "AcceleratedNetworking": {
                    "value": "[parameters('AcceleratedNetworking')]"
                  },
                  "Availability": {
                    "value": "[parameters('Availability')]"
                  },
                  "AvailabilityZones": {
                    "value": "[parameters('AvailabilityZones')]"
                  },
                  "AvailabilitySetPrefix": {
                    "value": "[parameters('AvailabilitySetPrefix')]"
                  },
                  "DeploymentScriptNamePrefix": {
                    "value": "[parameters('DeploymentScriptNamePrefix')]"
                  },
                  "DiskEncryption": {
                    "value": "[parameters('DiskEncryption')]"
                  },
                  "DiskName": {
                    "value": "[parameters('DiskName')]"
                  },
                  "DiskSku": {
                    "value": "[parameters('DiskSku')]"
                  },
                  "DomainJoinPassword": {
                    "value": "[parameters('DomainJoinPassword')]"
                  },
                  "DomainJoinUserPrincipalName": {
                    "value": "[parameters('DomainJoinUserPrincipalName')]"
                  },
                  "DomainName": {
                    "value": "[parameters('DomainName')]"
                  },
                  "ActiveDirectorySolution": {
                    "value": "[parameters('ActiveDirectorySolution')]"
                  },
                  "DrainMode": {
                    "value": "[parameters('DrainMode')]"
                  },
                  "Fslogix": {
                    "value": "[parameters('Fslogix')]"
                  },
                  "FslogixSolution": {
                    "value": "[parameters('FslogixSolution')]"
                  },
                  "HostPoolName": {
                    "value": "[parameters('HostPoolName')]"
                  },
                  "HostPoolType": {
                    "value": "[parameters('HostPoolType')]"
                  },
                  "ImageOffer": {
                    "value": "[parameters('ImageOffer')]"
                  },
                  "ImagePublisher": {
                    "value": "[parameters('ImagePublisher')]"
                  },
                  "ImageSku": {
                    "value": "[parameters('ImageSku')]"
                  },
                  "ImageVersion": {
                    "value": "[parameters('ImageVersion')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "LogAnalyticsWorkspaceName": {
                    "value": "[parameters('LogAnalyticsWorkspaceName')]"
                  },
                  "ManagedIdentityResourceId": {
                    "value": "[parameters('ManagedIdentityResourceId')]"
                  },
                  "Monitoring": {
                    "value": "[parameters('Monitoring')]"
                  },
                  "NamingStandard": {
                    "value": "[parameters('NamingStandard')]"
                  },
                  "NetAppFileShares": {
                    "value": "[parameters('NetAppFileShares')]"
                  },
                  "OuPath": {
                    "value": "[parameters('OuPath')]"
                  },
                  "ResourceGroupManagement": {
                    "value": "[parameters('ResourceGroupManagement')]"
                  },
                  "ScreenCaptureProtection": {
                    "value": "[parameters('ScreenCaptureProtection')]"
                  },
                  "Sentinel": {
                    "value": "[parameters('Sentinel')]"
                  },
                  "SentinelWorkspaceId": {
                    "value": "[parameters('SentinelWorkspaceId')]"
                  },
                  "SentinelWorkspaceResourceId": {
                    "value": "[parameters('SentinelWorkspaceResourceId')]"
                  },
                  "SessionHostCount": "[if(and(equals(range(1, parameters('SessionHostBatchCount'))[copyIndex()], parameters('SessionHostBatchCount')), greater(parameters('DivisionRemainderValue'), 0)), createObject('value', parameters('DivisionRemainderValue')), createObject('value', parameters('MaxResourcesPerTemplateDeployment')))]",
                  "SessionHostIndex": "[if(equals(range(1, parameters('SessionHostBatchCount'))[copyIndex()], 1), createObject('value', parameters('SessionHostIndex')), createObject('value', add(mul(sub(range(1, parameters('SessionHostBatchCount'))[copyIndex()], 1), parameters('MaxResourcesPerTemplateDeployment')), parameters('SessionHostIndex'))))]",
                  "StorageAccountPrefix": {
                    "value": "[parameters('StorageAccountPrefix')]"
                  },
                  "StorageCount": {
                    "value": "[parameters('StorageCount')]"
                  },
                  "StorageIndex": {
                    "value": "[parameters('StorageIndex')]"
                  },
                  "StorageSolution": {
                    "value": "[parameters('StorageSolution')]"
                  },
                  "StorageSuffix": {
                    "value": "[parameters('StorageSuffix')]"
                  },
                  "Subnet": {
                    "value": "[parameters('Subnet')]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  },
                  "TrustedLaunch": {
                    "value": "[parameters('TrustedLaunch')]"
                  },
                  "VirtualNetwork": {
                    "value": "[parameters('VirtualNetwork')]"
                  },
                  "VirtualNetworkResourceGroup": {
                    "value": "[parameters('VirtualNetworkResourceGroup')]"
                  },
                  "VmName": {
                    "value": "[parameters('VmName')]"
                  },
                  "VirtualMachinePassword": {
                    "value": "[parameters('VirtualMachinePassword')]"
                  },
                  "VirtualMachineSize": {
                    "value": "[parameters('VirtualMachineSize')]"
                  },
                  "VirtualMachineUsername": {
                    "value": "[parameters('VirtualMachineUsername')]"
                  },
                  "DiskEncryptionSetResourceId": {
                    "value": "[parameters('DiskEncryptionSetResourceId')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "2286537352928928528"
                    }
                  },
                  "parameters": {
                    "_artifactsLocation": {
                      "type": "string"
                    },
                    "_artifactsLocationSasToken": {
                      "type": "securestring"
                    },
                    "AcceleratedNetworking": {
                      "type": "string"
                    },
                    "Availability": {
                      "type": "string"
                    },
                    "AvailabilitySetPrefix": {
                      "type": "string"
                    },
                    "AvailabilityZones": {
                      "type": "array"
                    },
                    "DeploymentScriptNamePrefix": {
                      "type": "string"
                    },
                    "DiskEncryption": {
                      "type": "bool"
                    },
                    "DiskEncryptionSetResourceId": {
                      "type": "string"
                    },
                    "DiskName": {
                      "type": "string"
                    },
                    "DiskSku": {
                      "type": "string"
                    },
                    "DomainJoinPassword": {
                      "type": "securestring"
                    },
                    "DomainJoinUserPrincipalName": {
                      "type": "string"
                    },
                    "DomainName": {
                      "type": "string"
                    },
                    "ActiveDirectorySolution": {
                      "type": "string"
                    },
                    "DrainMode": {
                      "type": "bool"
                    },
                    "Fslogix": {
                      "type": "bool"
                    },
                    "FslogixSolution": {
                      "type": "string"
                    },
                    "HostPoolName": {
                      "type": "string"
                    },
                    "HostPoolType": {
                      "type": "string"
                    },
                    "ImageOffer": {
                      "type": "string"
                    },
                    "ImagePublisher": {
                      "type": "string"
                    },
                    "ImageSku": {
                      "type": "string"
                    },
                    "ImageVersion": {
                      "type": "string"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "LogAnalyticsWorkspaceName": {
                      "type": "string"
                    },
                    "ManagedIdentityResourceId": {
                      "type": "string"
                    },
                    "Monitoring": {
                      "type": "bool"
                    },
                    "NamingStandard": {
                      "type": "string"
                    },
                    "NetAppFileShares": {
                      "type": "array"
                    },
                    "OuPath": {
                      "type": "string"
                    },
                    "ResourceGroupManagement": {
                      "type": "string"
                    },
                    "ScreenCaptureProtection": {
                      "type": "bool"
                    },
                    "Sentinel": {
                      "type": "bool"
                    },
                    "SentinelWorkspaceId": {
                      "type": "string"
                    },
                    "SentinelWorkspaceResourceId": {
                      "type": "string"
                    },
                    "SessionHostCount": {
                      "type": "int"
                    },
                    "SessionHostIndex": {
                      "type": "int"
                    },
                    "StorageAccountPrefix": {
                      "type": "string"
                    },
                    "StorageCount": {
                      "type": "int"
                    },
                    "StorageIndex": {
                      "type": "int"
                    },
                    "StorageSolution": {
                      "type": "string"
                    },
                    "StorageSuffix": {
                      "type": "string"
                    },
                    "Subnet": {
                      "type": "string"
                    },
                    "Tags": {
                      "type": "object"
                    },
                    "Timestamp": {
                      "type": "string"
                    },
                    "TrustedLaunch": {
                      "type": "string"
                    },
                    "VirtualNetwork": {
                      "type": "string"
                    },
                    "VirtualNetworkResourceGroup": {
                      "type": "string"
                    },
                    "VmName": {
                      "type": "string"
                    },
                    "VirtualMachinePassword": {
                      "type": "securestring"
                    },
                    "VirtualMachineSize": {
                      "type": "string"
                    },
                    "VirtualMachineUsername": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "AmdVmSize": "[contains(variables('AmdVmSizes'), parameters('VirtualMachineSize'))]",
                    "AmdVmSizes": [
                      "Standard_NV4as_v4",
                      "Standard_NV8as_v4",
                      "Standard_NV16as_v4",
                      "Standard_NV32as_v4"
                    ],
                    "FslogixExclusions": "[format('\"%TEMP%\\*\\*.VHDX\";\"%Windir%\\TEMP\\*\\*.VHDX\"{0}{1}{2}', variables('FslogixExclusionsCloudCache'), variables('FslogixExclusionsProfileContainers'), variables('FslogixExclusionsOfficeContainers'))]",
                    "FslogixExclusionsCloudCache": "[if(contains(parameters('FslogixSolution'), 'CloudCache'), ';\"%ProgramData%\\FSLogix\\Cache\\*\";\"%ProgramData%\\FSLogix\\Proxy\\*\"', '')]",
                    "FslogixExclusionsOfficeContainers": "[if(contains(parameters('FslogixSolution'), 'Office'), format(';\"{0}\";\"{1}.lock\";\"{2}.meta\";\"{3}.metadata\"', variables('FslogixOfficeShare'), variables('FslogixOfficeShare'), variables('FslogixOfficeShare'), variables('FslogixOfficeShare')), '')]",
                    "FslogixExclusionsProfileContainers": "[format(';\"{0}\";\"{1}.lock\";\"{2}.meta\";\"{3}.metadata\"', variables('FslogixProfileShare'), variables('FslogixProfileShare'), variables('FslogixProfileShare'), variables('FslogixProfileShare'))]",
                    "FslogixOfficeShare": "[format('\\\\{0}?.file.{1}\\office-containers\\*\\*.VHDX', parameters('StorageAccountPrefix'), parameters('StorageSuffix'))]",
                    "FslogixProfileShare": "[format('\\\\{0}?.file.{1}\\profile-containers\\*\\*.VHDX', parameters('StorageAccountPrefix'), parameters('StorageSuffix'))]",
                    "Identity": "[if(not(contains(parameters('ActiveDirectorySolution'), 'DomainServices')), createObject('type', 'SystemAssigned'), null())]",
                    "Intune": "[contains(parameters('ActiveDirectorySolution'), 'IntuneEnrollment')]",
                    "NvidiaVmSize": "[contains(variables('NvidiaVmSizes'), parameters('VirtualMachineSize'))]",
                    "NvidiaVmSizes": [
                      "Standard_NV6",
                      "Standard_NV12",
                      "Standard_NV24",
                      "Standard_NV12s_v3",
                      "Standard_NV24s_v3",
                      "Standard_NV48s_v3",
                      "Standard_NC4as_T4_v3",
                      "Standard_NC8as_T4_v3",
                      "Standard_NC16as_T4_v3",
                      "Standard_NC64as_T4_v3",
                      "Standard_NV6ads_A10_v5",
                      "Standard_NV12ads_A10_v5",
                      "Standard_NV18ads_A10_v5",
                      "Standard_NV36ads_A10_v5",
                      "Standard_NV36adms_A10_v5",
                      "Standard_NV72ads_A10_v5"
                    ],
                    "PooledHostPool": "[equals(split(parameters('HostPoolType'), ' ')[0], 'Pooled')]"
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "networkInterface",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2020-05-01",
                      "name": "[format('nic-{0}-{1}', parameters('NamingStandard'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 4, '0'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[resourceId(subscription().subscriptionId, parameters('VirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', parameters('VirtualNetwork'), parameters('Subnet'))]"
                              },
                              "primary": true,
                              "privateIPAddressVersion": "IPv4"
                            }
                          }
                        ],
                        "enableAcceleratedNetworking": "[if(equals(parameters('AcceleratedNetworking'), 'True'), true(), false())]",
                        "enableIPForwarding": false
                      }
                    },
                    {
                      "copy": {
                        "name": "virtualMachine",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 4, '0'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "zones": "[if(equals(parameters('Availability'), 'AvailabilityZones'), createArray(parameters('AvailabilityZones')[mod(range(0, parameters('SessionHostCount'))[copyIndex()], length(parameters('AvailabilityZones')))]), null())]",
                      "identity": "[variables('Identity')]",
                      "properties": {
                        "availabilitySet": "[if(equals(parameters('Availability'), 'AvailabilitySet'), createObject('id', resourceId('Microsoft.Compute/availabilitySets', format('{0}-{1}', parameters('AvailabilitySetPrefix'), div(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 200)))), null())]",
                        "hardwareProfile": {
                          "vmSize": "[parameters('VirtualMachineSize')]"
                        },
                        "storageProfile": {
                          "imageReference": {
                            "publisher": "[parameters('ImagePublisher')]",
                            "offer": "[parameters('ImageOffer')]",
                            "sku": "[parameters('ImageSku')]",
                            "version": "[parameters('ImageVersion')]"
                          },
                          "osDisk": {
                            "name": "[format('{0}{1}', parameters('DiskName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 4, '0'))]",
                            "osType": "Windows",
                            "createOption": "FromImage",
                            "caching": "ReadWrite",
                            "deleteOption": "Delete",
                            "managedDisk": {
                              "diskEncryptionSet": "[if(parameters('DiskEncryption'), createObject('id', parameters('DiskEncryptionSetResourceId')), null())]",
                              "storageAccountType": "[parameters('DiskSku')]"
                            }
                          },
                          "dataDisks": []
                        },
                        "osProfile": {
                          "computerName": "[format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 4, '0'))]",
                          "adminUsername": "[parameters('VirtualMachineUsername')]",
                          "adminPassword": "[parameters('VirtualMachinePassword')]",
                          "windowsConfiguration": {
                            "provisionVMAgent": true,
                            "enableAutomaticUpdates": false
                          },
                          "secrets": [],
                          "allowExtensionOperations": true
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}-{1}', parameters('NamingStandard'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 4, '0')))]",
                              "properties": {
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "securityProfile": {
                          "uefiSettings": "[if(equals(parameters('TrustedLaunch'), 'true'), createObject('secureBootEnabled', true(), 'vTpmEnabled', true()), null())]",
                          "securityType": "[if(equals(parameters('TrustedLaunch'), 'true'), 'TrustedLaunch', null())]",
                          "encryptionAtHost": "[parameters('DiskEncryption')]"
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": false
                          }
                        },
                        "licenseType": "[if(equals(parameters('ImagePublisher'), 'MicrosoftWindowsDesktop'), 'Windows_Client', 'Windows_Server')]"
                      },
                      "dependsOn": [
                        "networkInterface"
                      ]
                    },
                    {
                      "copy": {
                        "name": "extension_IaasAntimalware",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}/{1}', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')), 'IaaSAntimalware')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Security",
                        "type": "IaaSAntimalware",
                        "typeHandlerVersion": "1.3",
                        "autoUpgradeMinorVersion": true,
                        "enableAutomaticUpgrade": false,
                        "settings": {
                          "AntimalwareEnabled": true,
                          "RealtimeProtectionEnabled": "true",
                          "ScheduledScanSettings": {
                            "isEnabled": "true",
                            "day": "7",
                            "time": "120",
                            "scanType": "Quick"
                          },
                          "Exclusions": "[if(parameters('Fslogix'), createObject('Paths', variables('FslogixExclusions')), createObject())]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "extension_MicrosoftMonitoringAgent",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "condition": "[parameters('Monitoring')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}/{1}', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')), 'MicrosoftMonitoringAgent')]",
                      "location": "[parameters('Location')]",
                      "properties": {
                        "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                        "type": "MicrosoftMonitoringAgent",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "workspaceId": "[if(parameters('Monitoring'), reference(resourceId(parameters('ResourceGroupManagement'), 'Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsWorkspaceName')), '2015-03-20').customerId, null())]"
                        },
                        "protectedSettings": {
                          "workspaceKey": "[if(parameters('Monitoring'), listKeys(resourceId(parameters('ResourceGroupManagement'), 'Microsoft.OperationalInsights/workspaces', parameters('LogAnalyticsWorkspaceName')), '2015-03-20').primarySharedKey, null())]"
                        }
                      },
                      "dependsOn": [
                        "extension_IaasAntimalware",
                        "[resourceId('Microsoft.Compute/virtualMachines', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "extension_CustomScriptExtension",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}/{1}', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')), 'CustomScriptExtension')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "CustomScriptExtension",
                        "typeHandlerVersion": "1.10",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "fileUris": [
                            "[format('{0}Set-SessionHostConfiguration.ps1{1}', parameters('_artifactsLocation'), parameters('_artifactsLocationSasToken'))]"
                          ],
                          "timestamp": "[parameters('Timestamp')]"
                        },
                        "protectedSettings": {
                          "commandToExecute": "[format('powershell -ExecutionPolicy Unrestricted -File Set-SessionHostConfiguration.ps1 -AmdVmSize {0} -DomainName {1} -ActiveDirectorySolution {2} -Environment {3} -FSLogix {4} -FslogixSolution {5} -HostPoolName {6} -HostPoolRegistrationToken {7} -ImageOffer {8} -ImagePublisher {9} -NetAppFileShares {10} -NvidiaVmSize {11} -PooledHostPool {12} -ScreenCaptureProtection {13} -Sentinel {14} -SentinelWorkspaceId {15} -SentinelWorkspaceKey {16} -StorageAccountPrefix {17} -StorageCount {18} -StorageIndex {19} -StorageSolution {20} -StorageSuffix {21}', variables('AmdVmSize'), parameters('DomainName'), parameters('ActiveDirectorySolution'), environment().name, parameters('Fslogix'), parameters('FslogixSolution'), parameters('HostPoolName'), reference(resourceId(parameters('ResourceGroupManagement'), 'Microsoft.DesktopVirtualization/hostpools', parameters('HostPoolName')), '2019-12-10-preview').registrationInfo.token, parameters('ImageOffer'), parameters('ImagePublisher'), parameters('NetAppFileShares'), variables('NvidiaVmSize'), variables('PooledHostPool'), parameters('ScreenCaptureProtection'), parameters('Sentinel'), parameters('SentinelWorkspaceId'), if(parameters('Sentinel'), listKeys(parameters('SentinelWorkspaceResourceId'), '2021-06-01').primarySharedKey, 'NotApplicable'), parameters('StorageAccountPrefix'), parameters('StorageCount'), parameters('StorageIndex'), parameters('StorageSolution'), parameters('StorageSuffix'))]"
                        }
                      },
                      "dependsOn": [
                        "extension_MicrosoftMonitoringAgent",
                        "[resourceId('Microsoft.Compute/virtualMachines', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "extension_JsonADDomainExtension",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "condition": "[contains(parameters('ActiveDirectorySolution'), 'DomainServices')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}/{1}', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')), 'JsonADDomainExtension')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "forceUpdateTag": "[parameters('Timestamp')]",
                        "publisher": "Microsoft.Compute",
                        "type": "JsonADDomainExtension",
                        "typeHandlerVersion": "1.3",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "Name": "[parameters('DomainName')]",
                          "User": "[parameters('DomainJoinUserPrincipalName')]",
                          "Restart": "true",
                          "Options": "3",
                          "OUPath": "[parameters('OuPath')]"
                        },
                        "protectedSettings": {
                          "Password": "[parameters('DomainJoinPassword')]"
                        }
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('DeploymentScript_DrainMode_{0}', parameters('Timestamp')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "extension_AADLoginForWindows",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "condition": "[not(contains(parameters('ActiveDirectorySolution'), 'DomainServices'))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}/{1}', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')), 'AADLoginForWindows')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.ActiveDirectory",
                        "type": "AADLoginForWindows",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "settings": "[if(variables('Intune'), createObject('mdmId', '0000000a-0000-0000-c000-000000000000'), null())]"
                      },
                      "dependsOn": [
                        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('DeploymentScript_DrainMode_{0}', parameters('Timestamp')))]",
                        "[resourceId('Microsoft.Compute/virtualMachines', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "extension_AmdGpuDriverWindows",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "condition": "[variables('AmdVmSize')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}/{1}', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')), 'AmdGpuDriverWindows')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "publisher": "Microsoft.HpcCompute",
                        "type": "AmdGpuDriverWindows",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true,
                        "settings": {}
                      },
                      "dependsOn": [
                        "extension_AADLoginForWindows",
                        "extension_JsonADDomainExtension",
                        "[resourceId('Microsoft.Compute/virtualMachines', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "extension_NvidiaGpuDriverWindows",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "condition": "[variables('NvidiaVmSize')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}/{1}', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')), 'NvidiaGpuDriverWindows')]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "publisher": "Microsoft.HpcCompute",
                        "type": "NvidiaGpuDriverWindows",
                        "typeHandlerVersion": "1.2",
                        "autoUpgradeMinorVersion": true,
                        "settings": {}
                      },
                      "dependsOn": [
                        "extension_AADLoginForWindows",
                        "extension_JsonADDomainExtension",
                        "[resourceId('Microsoft.Compute/virtualMachines', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[range(0, parameters('SessionHostCount'))[copyIndex()]], parameters('SessionHostIndex')), 4, '0')))]"
                      ]
                    },
                    {
                      "condition": "[parameters('DrainMode')]",
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2022-09-01",
                      "name": "[format('DeploymentScript_DrainMode_{0}', parameters('Timestamp'))]",
                      "resourceGroup": "[parameters('ResourceGroupManagement')]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "Arguments": {
                            "value": "[format('-ResourceGroup {0} -HostPool {1}', parameters('ResourceGroupManagement'), parameters('HostPoolName'))]"
                          },
                          "Location": {
                            "value": "[parameters('Location')]"
                          },
                          "Name": {
                            "value": "[format('{0}drain', parameters('DeploymentScriptNamePrefix'))]"
                          },
                          "Script": {
                            "value": "param([Parameter(Mandatory)][string]$HostPool,[Parameter(Mandatory)][string]$ResourceGroup); $SessionHosts = (Get-AzWvdSessionHost -ResourceGroupName $ResourceGroup -HostPoolName $HostPool).Name; foreach($SessionHost in $SessionHosts){$Name = ($SessionHost -split \"/\")[1]; Update-AzWvdSessionHost -ResourceGroupName $ResourceGroup -HostPoolName $HostPool -Name $Name -AllowNewSession:$False}; $DeploymentScriptOutputs = @{}; $DeploymentScriptOutputs[\"hostPool\"] = $HostPool"
                          },
                          "Timestamp": {
                            "value": "[parameters('Timestamp')]"
                          },
                          "UserAssignedIdentityResourceId": {
                            "value": "[parameters('ManagedIdentityResourceId')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.18.4.5664",
                              "templateHash": "1338006163064225507"
                            }
                          },
                          "parameters": {
                            "Arguments": {
                              "type": "string"
                            },
                            "Location": {
                              "type": "string"
                            },
                            "Name": {
                              "type": "string"
                            },
                            "Script": {
                              "type": "string"
                            },
                            "Timestamp": {
                              "type": "string"
                            },
                            "UserAssignedIdentityResourceId": {
                              "type": "string"
                            }
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deploymentScripts",
                              "apiVersion": "2020-10-01",
                              "name": "[parameters('Name')]",
                              "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                  "[format('{0}', parameters('UserAssignedIdentityResourceId'))]": {}
                                }
                              },
                              "location": "[parameters('Location')]",
                              "kind": "AzurePowerShell",
                              "tags": {},
                              "properties": {
                                "arguments": "[parameters('Arguments')]",
                                "azPowerShellVersion": "9.4",
                                "cleanupPreference": "Always",
                                "forceUpdateTag": "[parameters('Timestamp')]",
                                "retentionInterval": "PT2H",
                                "scriptContent": "[parameters('Script')]",
                                "timeout": "PT30M"
                              }
                            }
                          ],
                          "outputs": {
                            "properties": {
                              "type": "object",
                              "value": "[reference(resourceId('Microsoft.Resources/deploymentScripts', parameters('Name')), '2020-10-01').outputs]"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "extension_CustomScriptExtension"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "availabilitySets"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('DiskEncryption_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('FSLogix_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Monitoring_{0}', parameters('Timestamp')))]",
        "resourceGroups",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('SentinelLogAnalyticsWorkspaceSubscriptionId'), variables('SentinelResourceGroup')), 'Microsoft.Resources/deployments', format('Sentinel_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('UserAssignedIdentity_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Validations_{0}', parameters('Timestamp')))]"
      ]
    },
    {
      "condition": "[parameters('RecoveryServices')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('Backup_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroupManagement')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "DivisionRemainderValue": {
            "value": "[variables('DivisionRemainderValue')]"
          },
          "FileShares": {
            "value": "[variables('FileShares')]"
          },
          "Fslogix": {
            "value": "[variables('Fslogix')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "MaxResourcesPerTemplateDeployment": {
            "value": "[variables('MaxResourcesPerTemplateDeployment')]"
          },
          "RecoveryServicesVaultName": {
            "value": "[variables('RecoveryServicesVaultName')]"
          },
          "SessionHostBatchCount": {
            "value": "[variables('SessionHostBatchCount')]"
          },
          "SessionHostIndex": {
            "value": "[parameters('SessionHostIndex')]"
          },
          "StorageAccountPrefix": {
            "value": "[variables('StorageAccountPrefix')]"
          },
          "StorageCount": {
            "value": "[parameters('StorageCount')]"
          },
          "StorageIndex": {
            "value": "[parameters('StorageIndex')]"
          },
          "StorageResourceGroupName": {
            "value": "[variables('ResourceGroupStorage')]"
          },
          "StorageSolution": {
            "value": "[variables('StorageSolution')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "TimeZone": {
            "value": "[variables('Locations')[parameters('Location')].timeZone]"
          },
          "VmName": {
            "value": "[variables('VmName')]"
          },
          "VmResourceGroupName": {
            "value": "[variables('ResourceGroupHosts')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "3878131806781402204"
            }
          },
          "parameters": {
            "DivisionRemainderValue": {
              "type": "int"
            },
            "FileShares": {
              "type": "array"
            },
            "Fslogix": {
              "type": "bool"
            },
            "Location": {
              "type": "string"
            },
            "MaxResourcesPerTemplateDeployment": {
              "type": "int"
            },
            "RecoveryServicesVaultName": {
              "type": "string"
            },
            "SessionHostBatchCount": {
              "type": "int"
            },
            "SessionHostIndex": {
              "type": "int"
            },
            "StorageAccountPrefix": {
              "type": "string"
            },
            "StorageCount": {
              "type": "int"
            },
            "StorageIndex": {
              "type": "int"
            },
            "StorageResourceGroupName": {
              "type": "string"
            },
            "StorageSolution": {
              "type": "string"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string"
            },
            "TimeZone": {
              "type": "string"
            },
            "VmName": {
              "type": "string"
            },
            "VmResourceGroupName": {
              "type": "string"
            }
          },
          "variables": {
            "BackupSchedulePolicy": {
              "scheduleRunFrequency": "Daily",
              "scheduleRunTimes": [
                "23:00"
              ],
              "schedulePolicyType": "SimpleSchedulePolicy"
            },
            "BackupRetentionPolicy": {
              "retentionPolicyType": "LongTermRetentionPolicy",
              "dailySchedule": {
                "retentionTimes": [
                  "23:00"
                ],
                "retentionDuration": {
                  "count": 30,
                  "durationType": "Days"
                }
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.RecoveryServices/vaults",
              "apiVersion": "2022-03-01",
              "name": "[parameters('RecoveryServicesVaultName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "sku": {
                "name": "RS0",
                "tier": "Standard"
              },
              "properties": {}
            },
            {
              "condition": "[and(parameters('Fslogix'), equals(parameters('StorageSolution'), 'AzureStorageAccount'))]",
              "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
              "apiVersion": "2022-03-01",
              "name": "[format('{0}/{1}', parameters('RecoveryServicesVaultName'), 'AvdPolicyStorage')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "backupManagementType": "AzureStorage",
                "schedulePolicy": "[variables('BackupSchedulePolicy')]",
                "retentionPolicy": "[variables('BackupRetentionPolicy')]",
                "timeZone": "[parameters('TimeZone')]",
                "workLoadType": "AzureFileShare"
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('RecoveryServicesVaultName'))]"
              ]
            },
            {
              "condition": "[not(parameters('Fslogix'))]",
              "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
              "apiVersion": "2022-03-01",
              "name": "[format('{0}/{1}', parameters('RecoveryServicesVaultName'), 'AvdPolicyVm')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "backupManagementType": "AzureIaasVM",
                "schedulePolicy": "[variables('BackupSchedulePolicy')]",
                "retentionPolicy": "[variables('BackupRetentionPolicy')]",
                "timeZone": "[parameters('TimeZone')]",
                "instantRpRetentionRangeInDays": 2
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('RecoveryServicesVaultName'))]"
              ]
            },
            {
              "copy": {
                "name": "protectionContainers",
                "count": "[length(range(0, parameters('StorageCount')))]"
              },
              "condition": "[and(parameters('Fslogix'), equals(parameters('StorageSolution'), 'AzureStorageAccount'))]",
              "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers",
              "apiVersion": "2022-03-01",
              "name": "[format('{0}/Azure/storagecontainer;Storage;{1};{2}{3}', parameters('RecoveryServicesVaultName'), parameters('StorageResourceGroupName'), parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[copyIndex()], parameters('StorageIndex')))]",
              "properties": {
                "backupManagementType": "AzureStorage",
                "containerType": "StorageContainer",
                "sourceResourceId": "[resourceId(parameters('StorageResourceGroupName'), 'Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[copyIndex()], parameters('StorageIndex'))))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('RecoveryServicesVaultName'), 'AvdPolicyStorage')]",
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('RecoveryServicesVaultName'))]"
              ]
            },
            {
              "copy": {
                "name": "protectedItems_FileShares",
                "count": "[length(range(0, parameters('StorageCount')))]"
              },
              "condition": "[and(parameters('Fslogix'), equals(parameters('StorageSolution'), 'AzureStorageAccount'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('BackupProtectedItems_FileShares_{0}_{1}', add(range(0, parameters('StorageCount'))[copyIndex()], parameters('StorageIndex')), parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "FileShares": {
                    "value": "[parameters('FileShares')]"
                  },
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "ProtectionContainerName": {
                    "value": "[format('{0}/Azure/storagecontainer;Storage;{1};{2}{3}', parameters('RecoveryServicesVaultName'), parameters('StorageResourceGroupName'), parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex')))]"
                  },
                  "PolicyId": {
                    "value": "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('RecoveryServicesVaultName'), 'AvdPolicyStorage')]"
                  },
                  "SourceResourceId": {
                    "value": "[resourceId(parameters('StorageResourceGroupName'), 'Microsoft.Storage/storageAccounts', format('{0}{1}', parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[copyIndex()], parameters('StorageIndex'))))]"
                  },
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "3575042952203700702"
                    }
                  },
                  "parameters": {
                    "FileShares": {
                      "type": "array"
                    },
                    "Location": {
                      "type": "string"
                    },
                    "PolicyId": {
                      "type": "string"
                    },
                    "ProtectionContainerName": {
                      "type": "string"
                    },
                    "SourceResourceId": {
                      "type": "string"
                    },
                    "Tags": {
                      "type": "object"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "protectedItems_FileShare",
                        "count": "[length(parameters('FileShares'))]"
                      },
                      "condition": "[contains(parameters('FileShares')[copyIndex()], 'profile')]",
                      "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/AzureFileShare;{1}', parameters('ProtectionContainerName'), parameters('FileShares')[copyIndex()])]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "protectedItemType": "AzureFileShareProtectedItem",
                        "policyId": "[parameters('PolicyId')]",
                        "sourceResourceId": "[parameters('SourceResourceId')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('RecoveryServicesVaultName'), 'AvdPolicyStorage')]",
                "[resourceId('Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers', split(format('{0}/Azure/storagecontainer;Storage;{1};{2}{3}', parameters('RecoveryServicesVaultName'), parameters('StorageResourceGroupName'), parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))), '/')[0], split(format('{0}/Azure/storagecontainer;Storage;{1};{2}{3}', parameters('RecoveryServicesVaultName'), parameters('StorageResourceGroupName'), parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))), '/')[1], split(format('{0}/Azure/storagecontainer;Storage;{1};{2}{3}', parameters('RecoveryServicesVaultName'), parameters('StorageResourceGroupName'), parameters('StorageAccountPrefix'), add(range(0, parameters('StorageCount'))[range(0, parameters('StorageCount'))[copyIndex()]], parameters('StorageIndex'))), '/')[2])]"
              ]
            },
            {
              "copy": {
                "name": "protectedItems_Vm",
                "count": "[length(range(1, parameters('SessionHostBatchCount')))]"
              },
              "condition": "[not(parameters('Fslogix'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('BackupProtectedItems_VirtualMachines_{0}_{1}', sub(range(1, parameters('SessionHostBatchCount'))[copyIndex()], 1), parameters('Timestamp'))]",
              "resourceGroup": "[resourceGroup().name]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "Location": {
                    "value": "[parameters('Location')]"
                  },
                  "PolicyId": {
                    "value": "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('RecoveryServicesVaultName'), 'AvdPolicyVm')]"
                  },
                  "RecoveryServicesVaultName": {
                    "value": "[parameters('RecoveryServicesVaultName')]"
                  },
                  "SessionHostCount": "[if(and(equals(range(1, parameters('SessionHostBatchCount'))[copyIndex()], parameters('SessionHostBatchCount')), greater(parameters('DivisionRemainderValue'), 0)), createObject('value', parameters('DivisionRemainderValue')), createObject('value', parameters('MaxResourcesPerTemplateDeployment')))]",
                  "SessionHostIndex": "[if(equals(range(1, parameters('SessionHostBatchCount'))[copyIndex()], 1), createObject('value', parameters('SessionHostIndex')), createObject('value', add(mul(sub(range(1, parameters('SessionHostBatchCount'))[copyIndex()], 1), parameters('MaxResourcesPerTemplateDeployment')), parameters('SessionHostIndex'))))]",
                  "Tags": {
                    "value": "[parameters('Tags')]"
                  },
                  "VmName": {
                    "value": "[parameters('VmName')]"
                  },
                  "VmResourceGroupName": {
                    "value": "[parameters('VmResourceGroupName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "7989728395005310515"
                    }
                  },
                  "parameters": {
                    "Location": {
                      "type": "string"
                    },
                    "PolicyId": {
                      "type": "string"
                    },
                    "RecoveryServicesVaultName": {
                      "type": "string"
                    },
                    "SessionHostCount": {
                      "type": "int"
                    },
                    "SessionHostIndex": {
                      "type": "int"
                    },
                    "Tags": {
                      "type": "object"
                    },
                    "VmName": {
                      "type": "string"
                    },
                    "VmResourceGroupName": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "v2VmContainer": "iaasvmcontainer;iaasvmcontainerv2;",
                    "v2Vm": "vm;iaasvmcontainerv2;"
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "protectedItems_Vm",
                        "count": "[length(range(0, parameters('SessionHostCount')))]"
                      },
                      "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems",
                      "apiVersion": "2021-08-01",
                      "name": "[format('{0}/Azure/{1}{2};{3}{4}/{5}{6};{7}{8}', parameters('RecoveryServicesVaultName'), variables('v2VmContainer'), parameters('VmResourceGroupName'), parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 4, '0'), variables('v2Vm'), parameters('VmResourceGroupName'), parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 4, '0'))]",
                      "location": "[parameters('Location')]",
                      "tags": "[parameters('Tags')]",
                      "properties": {
                        "protectedItemType": "Microsoft.Compute/virtualMachines",
                        "policyId": "[parameters('PolicyId')]",
                        "sourceResourceId": "[resourceId(parameters('VmResourceGroupName'), 'Microsoft.Compute/virtualMachines', format('{0}{1}', parameters('VmName'), padLeft(add(range(0, parameters('SessionHostCount'))[copyIndex()], parameters('SessionHostIndex')), 4, '0')))]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('RecoveryServicesVaultName'), 'AvdPolicyVm')]",
                "[resourceId('Microsoft.RecoveryServices/vaults', parameters('RecoveryServicesVaultName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('FSLogix_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupHosts')), 'Microsoft.Resources/deployments', format('SessionHosts_{0}', parameters('Timestamp')))]"
      ]
    },
    {
      "condition": "[and(parameters('ScalingTool'), variables('PooledHostPool'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('ScalingTool_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroupManagement')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "AutomationAccountName": {
            "value": "[variables('AutomationAccountName')]"
          },
          "BeginPeakTime": {
            "value": "[parameters('ScalingBeginPeakTime')]"
          },
          "EndPeakTime": {
            "value": "[parameters('ScalingEndPeakTime')]"
          },
          "HostPoolName": {
            "value": "[variables('HostPoolName')]"
          },
          "HostPoolResourceGroupName": {
            "value": "[variables('ResourceGroupManagement')]"
          },
          "LimitSecondsToForceLogOffUser": {
            "value": "[parameters('ScalingLimitSecondsToForceLogOffUser')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "MinimumNumberOfRdsh": {
            "value": "[parameters('ScalingMinimumNumberOfRdsh')]"
          },
          "ResourceGroupHosts": {
            "value": "[variables('ResourceGroupHosts')]"
          },
          "ResourceGroupManagement": {
            "value": "[variables('ResourceGroupManagement')]"
          },
          "SessionThresholdPerCPU": {
            "value": "[parameters('ScalingSessionThresholdPerCPU')]"
          },
          "TimeDifference": {
            "value": "[variables('Locations')[parameters('Location')].timeDifference]"
          },
          "TimeZone": {
            "value": "[variables('Locations')[parameters('Location')].timeZone]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "3640947398637315491"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string"
            },
            "_artifactsLocationSasToken": {
              "type": "securestring"
            },
            "AutomationAccountName": {
              "type": "string"
            },
            "BeginPeakTime": {
              "type": "string"
            },
            "EndPeakTime": {
              "type": "string"
            },
            "HostPoolName": {
              "type": "string"
            },
            "HostPoolResourceGroupName": {
              "type": "string"
            },
            "LimitSecondsToForceLogOffUser": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "MinimumNumberOfRdsh": {
              "type": "string"
            },
            "ResourceGroupHosts": {
              "type": "string"
            },
            "ResourceGroupManagement": {
              "type": "string"
            },
            "SessionThresholdPerCPU": {
              "type": "string"
            },
            "TimeDifference": {
              "type": "string"
            },
            "Time": {
              "type": "string",
              "defaultValue": "[utcNow('u')]"
            },
            "TimeZone": {
              "type": "string"
            }
          },
          "variables": {
            "RoleAssignments": [
              "[parameters('ResourceGroupHosts')]",
              "[parameters('ResourceGroupManagement')]"
            ]
          },
          "resources": [
            {
              "type": "Microsoft.Automation/automationAccounts/runbooks",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}', parameters('AutomationAccountName'), 'Scaling-Tool')]",
              "location": "[parameters('Location')]",
              "properties": {
                "runbookType": "PowerShell",
                "logProgress": false,
                "logVerbose": false,
                "publishContentLink": {
                  "uri": "[format('{0}Set-HostPoolScaling.ps1{1}', parameters('_artifactsLocation'), parameters('_artifactsLocationSasToken'))]",
                  "version": "1.0.0.0"
                }
              }
            },
            {
              "copy": {
                "name": "schedules",
                "count": "[length(range(0, 4))]"
              },
              "type": "Microsoft.Automation/automationAccounts/schedules",
              "apiVersion": "2022-08-08",
              "name": "[format('{0}/{1}', parameters('AutomationAccountName'), format('{0}_{1}min', parameters('HostPoolName'), mul(add(range(0, 4)[copyIndex()], 1), 15)))]",
              "properties": {
                "advancedSchedule": {},
                "description": null,
                "expiryTime": null,
                "frequency": "Hour",
                "interval": 1,
                "startTime": "[dateTimeAdd(parameters('Time'), format('PT{0}M', mul(add(range(0, 4)[copyIndex()], 1), 15)))]",
                "timeZone": "[parameters('TimeZone')]"
              }
            },
            {
              "copy": {
                "name": "jobSchedules",
                "count": "[length(range(0, 4))]"
              },
              "type": "Microsoft.Automation/automationAccounts/jobSchedules",
              "apiVersion": "2022-08-08",
              "name": "[format('{0}/{1}', parameters('AutomationAccountName'), guid(parameters('Time'), 'Scaling-Tool', parameters('HostPoolName'), string(range(0, 4)[copyIndex()])))]",
              "properties": {
                "parameters": {
                  "BeginPeakTime": "[parameters('BeginPeakTime')]",
                  "EndPeakTime": "[parameters('EndPeakTime')]",
                  "EnvironmentName": "[environment().name]",
                  "HostPoolName": "[parameters('HostPoolName')]",
                  "LimitSecondsToForceLogOffUser": "[parameters('LimitSecondsToForceLogOffUser')]",
                  "LogOffMessageBody": "Your session will be logged off. Please save and close everything.",
                  "LogOffMessageTitle": "Machine is about to shutdown.",
                  "MaintenanceTagName": "Maintenance",
                  "MinimumNumberOfRDSH": "[parameters('MinimumNumberOfRdsh')]",
                  "ResourceGroupName": "[parameters('HostPoolResourceGroupName')]",
                  "SessionThresholdPerCPU": "[parameters('SessionThresholdPerCPU')]",
                  "SubscriptionId": "[subscription().subscriptionId]",
                  "TenantId": "[subscription().tenantId]",
                  "TimeDifference": "[parameters('TimeDifference')]"
                },
                "runbook": {
                  "name": "Scaling-Tool"
                },
                "runOn": null,
                "schedule": {
                  "name": "[format('{0}_{1}min', parameters('HostPoolName'), mul(add(range(0, 4)[range(0, 4)[copyIndex()]], 1), 15))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts/runbooks', parameters('AutomationAccountName'), 'Scaling-Tool')]",
                "[resourceId('Microsoft.Automation/automationAccounts/schedules', parameters('AutomationAccountName'), format('{0}_{1}min', parameters('HostPoolName'), mul(add(range(0, 4)[range(0, 4)[copyIndex()]], 1), 15)))]"
              ]
            },
            {
              "copy": {
                "name": "roleAssignment",
                "count": "[length(range(0, length(variables('RoleAssignments'))))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('RoleAssignment_{0}_{1}', range(0, length(variables('RoleAssignments')))[copyIndex()], variables('RoleAssignments')[range(0, length(variables('RoleAssignments')))[copyIndex()]])]",
              "resourceGroup": "[variables('RoleAssignments')[range(0, length(variables('RoleAssignments')))[copyIndex()]]]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrincipalId": {
                    "value": "[reference(resourceId('Microsoft.Automation/automationAccounts', parameters('AutomationAccountName')), '2022-08-08', 'full').identity.principalId]"
                  },
                  "RoleDefinitionId": {
                    "value": "[resourceId('Microsoft.Authorization/roleDefinitions', '40c5ff49-9181-41f8-ae61-143b0e78555e')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "8096479380248432665"
                    }
                  },
                  "parameters": {
                    "PrincipalId": {
                      "type": "string"
                    },
                    "RoleDefinitionId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "name": "[guid(parameters('PrincipalId'), parameters('RoleDefinitionId'), resourceGroup().id)]",
                      "properties": {
                        "roleDefinitionId": "[parameters('RoleDefinitionId')]",
                        "principalId": "[parameters('PrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('AutomationAccount_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Backup_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupHosts')), 'Microsoft.Resources/deployments', format('SessionHosts_{0}', parameters('Timestamp')))]"
      ]
    },
    {
      "condition": "[and(contains(parameters('FslogixStorage'), 'AzureStorageAccount Premium'), greater(parameters('StorageCount'), 0))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('AutoIncreasePremiumFileShareQuota_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[variables('ResourceGroupManagement')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "AutomationAccountName": {
            "value": "[variables('AutomationAccountName')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "StorageAccountPrefix": {
            "value": "[variables('StorageAccountPrefix')]"
          },
          "StorageCount": {
            "value": "[parameters('StorageCount')]"
          },
          "StorageIndex": {
            "value": "[parameters('StorageIndex')]"
          },
          "StorageResourceGroupName": {
            "value": "[variables('ResourceGroupStorage')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "TimeZone": {
            "value": "[variables('Locations')[parameters('Location')].timeZone]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "8809534826817605357"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string"
            },
            "_artifactsLocationSasToken": {
              "type": "securestring"
            },
            "AutomationAccountName": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "StorageAccountPrefix": {
              "type": "string"
            },
            "StorageCount": {
              "type": "int"
            },
            "StorageIndex": {
              "type": "int"
            },
            "StorageResourceGroupName": {
              "type": "string"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string"
            },
            "TimeZone": {
              "type": "string"
            }
          },
          "variables": {
            "RunbookName": "Auto-Increase-Premium-File-Share-Quota",
            "SubscriptionId": "[subscription().subscriptionId]"
          },
          "resources": [
            {
              "type": "Microsoft.Automation/automationAccounts/runbooks",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}', parameters('AutomationAccountName'), variables('RunbookName'))]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "runbookType": "PowerShell",
                "logProgress": false,
                "logVerbose": false,
                "publishContentLink": {
                  "uri": "[format('{0}Set-FileShareScaling.ps1{1}', parameters('_artifactsLocation'), parameters('_artifactsLocationSasToken'))]",
                  "version": "1.0.0.0"
                }
              }
            },
            {
              "copy": {
                "name": "schedules",
                "count": "[length(range(parameters('StorageIndex'), parameters('StorageCount')))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('Schedules_{0}_{1}', range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()], parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "AutomationAccountName": {
                    "value": "[parameters('AutomationAccountName')]"
                  },
                  "StorageAccountName": {
                    "value": "[format('{0}{1}', parameters('StorageAccountPrefix'), range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()])]"
                  },
                  "TimeZone": {
                    "value": "[parameters('TimeZone')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "8685773594552347600"
                    }
                  },
                  "parameters": {
                    "AutomationAccountName": {
                      "type": "string"
                    },
                    "StorageAccountName": {
                      "type": "string"
                    },
                    "Time": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    },
                    "TimeZone": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "schedules_ProfileContainers",
                        "count": "[length(range(0, 4))]"
                      },
                      "type": "Microsoft.Automation/automationAccounts/schedules",
                      "apiVersion": "2022-08-08",
                      "name": "[format('{0}/{1}', parameters('AutomationAccountName'), format('{0}_ProfileContainers_{1}min', parameters('StorageAccountName'), mul(add(range(0, 4)[copyIndex()], 1), 15)))]",
                      "properties": {
                        "advancedSchedule": {},
                        "description": null,
                        "expiryTime": null,
                        "frequency": "Hour",
                        "interval": 1,
                        "startTime": "[dateTimeAdd(parameters('Time'), format('PT{0}M', mul(add(range(0, 4)[copyIndex()], 1), 15)))]",
                        "timeZone": "[parameters('TimeZone')]"
                      }
                    },
                    {
                      "copy": {
                        "name": "schedules_OfficeContainers",
                        "count": "[length(range(0, 4))]"
                      },
                      "type": "Microsoft.Automation/automationAccounts/schedules",
                      "apiVersion": "2022-08-08",
                      "name": "[format('{0}/{1}', parameters('AutomationAccountName'), format('{0}_OfficeContainers_{1}min', parameters('StorageAccountName'), mul(add(range(0, 4)[copyIndex()], 1), 15)))]",
                      "properties": {
                        "advancedSchedule": {},
                        "description": null,
                        "expiryTime": null,
                        "frequency": "Hour",
                        "interval": 1,
                        "startTime": "[dateTimeAdd(parameters('Time'), format('PT{0}M', mul(add(range(0, 4)[copyIndex()], 1), 15)))]",
                        "timeZone": "[parameters('TimeZone')]"
                      }
                    }
                  ]
                }
              }
            },
            {
              "copy": {
                "name": "jobSchedules",
                "count": "[length(range(parameters('StorageIndex'), parameters('StorageCount')))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('JobSchedules_{0}_{1}', range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()], parameters('Timestamp'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "AutomationAccountName": {
                    "value": "[parameters('AutomationAccountName')]"
                  },
                  "Environment": {
                    "value": "[environment().name]"
                  },
                  "RunbookName": {
                    "value": "[variables('RunbookName')]"
                  },
                  "ResourceGroupName": {
                    "value": "[parameters('StorageResourceGroupName')]"
                  },
                  "StorageAccountName": {
                    "value": "[format('{0}{1}', parameters('StorageAccountPrefix'), range(parameters('StorageIndex'), parameters('StorageCount'))[copyIndex()])]"
                  },
                  "SubscriptionId": {
                    "value": "[variables('SubscriptionId')]"
                  },
                  "Timestamp": {
                    "value": "[parameters('Timestamp')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "11025167999116827115"
                    }
                  },
                  "parameters": {
                    "AutomationAccountName": {
                      "type": "string"
                    },
                    "Environment": {
                      "type": "string"
                    },
                    "ResourceGroupName": {
                      "type": "string"
                    },
                    "RunbookName": {
                      "type": "string"
                    },
                    "StorageAccountName": {
                      "type": "string"
                    },
                    "SubscriptionId": {
                      "type": "string"
                    },
                    "Timestamp": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "jobSchedules_ProfileContainers",
                        "count": "[length(range(0, 4))]"
                      },
                      "type": "Microsoft.Automation/automationAccounts/jobSchedules",
                      "apiVersion": "2022-08-08",
                      "name": "[format('{0}/{1}', parameters('AutomationAccountName'), guid(parameters('Timestamp'), parameters('RunbookName'), parameters('StorageAccountName'), 'ProfileContainers', string(range(0, 4)[copyIndex()])))]",
                      "properties": {
                        "parameters": {
                          "Environment": "[parameters('Environment')]",
                          "FileShareName": "profilecontainers",
                          "ResourceGroupName": "[parameters('ResourceGroupName')]",
                          "StorageAccountName": "[parameters('StorageAccountName')]",
                          "SubscriptionId": "[parameters('SubscriptionId')]"
                        },
                        "runbook": {
                          "name": "[parameters('RunbookName')]"
                        },
                        "runOn": null,
                        "schedule": {
                          "name": "[format('{0}_ProfileContainers_{1}min', parameters('StorageAccountName'), mul(add(range(0, 4)[copyIndex()], 1), 15))]"
                        }
                      }
                    },
                    {
                      "copy": {
                        "name": "jobSchedules_OfficeContainers",
                        "count": "[length(range(0, 4))]"
                      },
                      "type": "Microsoft.Automation/automationAccounts/jobSchedules",
                      "apiVersion": "2022-08-08",
                      "name": "[format('{0}/{1}', parameters('AutomationAccountName'), guid(parameters('Timestamp'), parameters('RunbookName'), parameters('StorageAccountName'), 'OfficeContainers', string(range(0, 4)[copyIndex()])))]",
                      "properties": {
                        "parameters": {
                          "Environment": "[parameters('Environment')]",
                          "FileShareName": "officecontainers",
                          "ResourceGroupName": "[parameters('ResourceGroupName')]",
                          "StorageAccountName": "[parameters('StorageAccountName')]",
                          "SubscriptionId": "[parameters('SubscriptionId')]"
                        },
                        "runbook": {
                          "name": "[parameters('RunbookName')]"
                        },
                        "runOn": null,
                        "schedule": {
                          "name": "[format('{0}_OfficeContainers_{1}min', parameters('StorageAccountName'), mul(add(range(0, 4)[copyIndex()], 1), 15))]"
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts/runbooks', parameters('AutomationAccountName'), variables('RunbookName'))]",
                "schedules"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('RoleAssignment_{0}_{1}', parameters('StorageResourceGroupName'), parameters('Timestamp'))]",
              "resourceGroup": "[parameters('StorageResourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "PrincipalId": {
                    "value": "[reference(resourceId('Microsoft.Automation/automationAccounts', parameters('AutomationAccountName')), '2022-08-08', 'full').identity.principalId]"
                  },
                  "RoleDefinitionId": {
                    "value": "[resourceId('Microsoft.Authorization/roleDefinitions', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.18.4.5664",
                      "templateHash": "8096479380248432665"
                    }
                  },
                  "parameters": {
                    "PrincipalId": {
                      "type": "string"
                    },
                    "RoleDefinitionId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2022-04-01",
                      "name": "[guid(parameters('PrincipalId'), parameters('RoleDefinitionId'), resourceGroup().id)]",
                      "properties": {
                        "roleDefinitionId": "[parameters('RoleDefinitionId')]",
                        "principalId": "[parameters('PrincipalId')]",
                        "principalType": "ServicePrincipal"
                      }
                    }
                  ]
                }
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('AutomationAccount_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('Backup_{0}', parameters('Timestamp')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('ResourceGroupManagement')), 'Microsoft.Resources/deployments', format('FSLogix_{0}', parameters('Timestamp')))]"
      ]
    }
  ]
}